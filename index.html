<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ãƒŸãƒ¥ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</title>

  <!-- PWA / ã‚¢ã‚¤ã‚³ãƒ³é–¢é€£ -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16.png" />
  <meta name="apple-mobile-web-app-title" content="ãƒŸãƒ¥ãƒ¼ãƒˆã‚«ãƒƒãƒˆ">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- ffmpeg.wasm (CDN) -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

  <!-- Service Worker (COOP/COEP) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./coi-serviceworker.js').catch(e=>{});
      });
    }
  </script>

  <style>
    :root {
      /* --- Dark Mode Variables --- */
      --bg-body: #000000;
      --bg-grad-1: #0f1219;
      --bg-grad-2: #000000;
      
      --glass-bg: rgba(28, 28, 30, 0.65);
      --glass-border: color-mix(in srgb, var(--primary) 16%, transparent);
      --glass-shadow: 0 20px 40px 0 rgba(0, 0, 0, 0.6);
      
      --primary: #8DC21F;
      --primary-hover: #a3db2e;
      --accent: #60fa74;
      --danger: #ff5c5c;
      
      --text-main: #f5f5f7;
      --text-muted: #86868b;
      --text-logo: #f5f5f7;
      
      --input-bg: rgba(255, 255, 255, 0.08);
      --radius: 20px;
      
      --font-base: "Noto Sans JP", "Inter", sans-serif;
      --font-mono: "Roboto Mono", monospace;
    }

    /* --- Light Mode Override --- */
    body.light-mode {
      --bg-body: #f2f4f7;
      --bg-grad-1: #eef2f6;
      --bg-grad-2: #e0e7ff;
      
      --glass-bg: rgba(255, 255, 255, 0.75);
      --glass-border: color-mix(in srgb, var(--primary) 36%, transparent);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.08);
      
      --primary: #74a813; 
      --primary-hover: #8DC21F;
      --accent: #03a454;
      --danger: #ff3b30;
      
      --text-main: #1d1d1f;
      --text-muted: #6e6e73;
      --text-logo: #595757;
      
      --input-bg: rgba(255, 255, 255, 0.6);
    }

    * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s, fill 0.3s; }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, var(--bg-grad-1), var(--bg-grad-2));
      color: var(--text-main);
      font-family: var(--font-base);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      width: 100%;
    }

    .bg-orb {
      position: absolute;
      width: 900px; height: 900px;
      background: radial-gradient(circle, var(--primary) 0%, transparent 65%);
      opacity: 0.08;
      top: -400px; right: -200px;
      pointer-events: none; z-index: 0;
      filter: blur(120px); transition: opacity 0.5s;
    }
    body.light-mode .bg-orb { opacity: 0.15; }

    /* --- Header --- */
    header {
      height: 72px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      display: flex; align-items: center; padding: 0 32px;
      flex-shrink: 0; z-index: 100;
      width: 100%;
    }
    .header-inner {
      width: 100%; max-width: 1920px; margin: 0 auto;
      display: flex; justify-content: space-between; align-items: center;
    }
    
    .logo { width: 220px; height: auto; flex-shrink: 1; } 
    .logo svg { width: 100%; height: auto; display: block; }

    .icon { width: 18px; height: 18px; fill: currentColor; display: inline-block; vertical-align: middle; }
    .icon-lg { width: 32px; height: 32px; fill: currentColor; }
    .icon-btn { margin-right: 8px; }

    .theme-toggle {
      background: var(--input-bg);
      border: 1px solid var(--glass-border);
      color: var(--text-main);
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.2s; flex-shrink: 0;
    }
    .theme-toggle:hover { background: var(--glass-border); transform: scale(1.05); }

    /* --- Layout --- */
    main {
      flex: 1; display: grid;
      grid-template-columns: 450px 1fr;
      gap: 0; overflow: hidden;
      width: 100%; max-width: 1920px; margin: 0 auto;
      position: relative; z-index: 1;
    }
    
    .panel-left {
      background: var(--glass-bg);
      backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
      border-right: 1px solid var(--glass-border);
      padding: 32px; display: flex; flex-direction: column; gap: 28px;
      overflow-y: auto;
    }
    .panel-right {
      background: rgba(0,0,0,0.02); padding: 32px;
      display: flex; flex-direction: column; gap: 20px;
      overflow-y: auto;
    }

    /* === Mobile / Vertical Layout Optimization === */
    @media (max-width: 1024px) {
      body { height: auto; overflow-y: auto; }
      header { padding: 0 16px; }
      .logo { width: 140px; }

      main { 
        display: flex; 
        flex-direction: column; 
        overflow: visible;
        padding-bottom: 60px;
      }

      .panel-left, .panel-right {
        display: contents;
      }

      /* 1. Top: File Input */
      .drop-zone {
        order: 1;
        margin: 16px 16px 10px 16px !important;
        padding: 12px !important;
        flex-direction: row; gap: 12px; align-items: center; justify-content: center;
        min-height: auto;
      }
      .drop-zone-icon { margin: 0 !important; width: 24px; height: 24px; }
      .drop-zone-icon svg { width: 100%; height: 100%; }
      .drop-zone-text { margin: 0 !important; font-size: 13px; }
      .drop-zone div:last-child { display: none; }

      /* 2. Preview */
      .preview-container {
        order: 2;
        margin: 0 16px 16px 16px !important;
        max-height: 40vh !important;
        width: calc(100% - 32px) !important;
      }

      /* 3-8. Controls & Timeline */
      .panel-right > div, .panel-left > div {
        order: 10;
        margin: 0 16px 16px 16px;
        width: calc(100% - 32px);
      }
      
      .panel-right > div:has(#waveformCanvas) { order: 3; }
      .segment-list-container { order: 4; }
      .panel-right > div:has(#previewCutBtn) { order: 5; }
      .stats-card { order: 6; }
      .control-group { order: 7; }
      .log-console { order: 8; }

      /* 9. Export */
      .export-section {
        order: 100;
        margin: 16px 16px 40px 16px !important;
        width: calc(100% - 32px) !important;
      }
    }

    h2 {
      margin: 0 0 16px; font-size: 14px; font-weight: 700;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em;
      display: flex; align-items: center; gap: 10px;
    }
    h2 svg { color: var(--primary); width: 18px; height: 18px; }

    /* --- Components --- */
    .glass-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      box-shadow: var(--glass-shadow);
      backdrop-filter: blur(10px);
    }

    .drop-zone {
      @extend .glass-card;
      background: var(--input-bg);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius);
      padding: 30px 20px; text-align: center;
      cursor: pointer; transition: 0.2s; color: var(--text-muted);
    }
    .drop-zone:hover { 
      border-color: var(--primary); background: rgba(141,194,31,0.08); color: var(--primary);
    }
    .drop-zone-icon { margin-bottom: 12px; color: inherit; }
    .drop-zone-text { font-size: 15px; font-weight: 700; margin-top: 0; color: var(--text-main); }

    .stats-card {
      background: linear-gradient(135deg, rgba(34, 194, 31, 0.276), rgba(141, 194, 31, 0.02));
      border: 1px solid color-mix(in srgb, var(--primary) 36%, transparent);
      border-radius: var(--radius);
      padding: 16px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: all 0.3s;
    }
    body.light-mode .stats-card {
      background: linear-gradient(135deg, rgba(13, 193, 31, 0.253), rgba(74, 255, 222, 0.238));
      border: 1px solid color-mix(in srgb, var(--primary) 36%, transparent);
      box-shadow: 0 4px 12px rgba(74, 163, 255, 0.1);
    }
    .stat-item { text-align: center; }
    .stat-label { font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px; font-weight: 600; }
    .stat-value { font-family: var(--font-mono); font-size: 16px; font-weight: 700; color: var(--text-main); }
    .stat-arrow { color: var(--text-muted); width: 16px; height: 16px; }
    .stat-saving { color: var(--primary); font-size: 12px; font-weight: 800; }
    body.light-mode .stat-saving { color: var(--accent); }

    .control-group {
      background: var(--input-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 24px;
      box-shadow: inset 0 1px 1px rgba(255,255,255,0.05);
    }
    .slider-item { margin-bottom: 28px; }
    .slider-item:last-child { margin-bottom: 0; }
    .slider-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; font-weight: 600; }
    .slider-desc { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; line-height: 1.4; opacity: 0.9; }
    .label-val { color: var(--accent); font-family: var(--font-mono); font-size: 14px; }
    
    input[type="range"] {
      width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      width: 100%; height: 8px; background: var(--glass-border); border-radius: 4px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 26px; width: 26px;
      border-radius: 50%; background: var(--text-main); margin-top: -9px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4); transition: transform 0.1s;
      border: 1px solid var(--glass-border);
    }
    input[type="range"]:active::-webkit-slider-thumb { transform: scale(1.15); background: var(--primary); border-color: transparent; }

    .preview-container {
      width: 100%; max-width: 600px; margin: 0 auto;
      background: #000; border-radius: var(--radius);
      overflow: hidden; border: 1px solid var(--glass-border);
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      display: flex; justify-content: center; align-items: center;
      aspect-ratio: 16 / 9; flex-shrink: 0;
    }
    video { width: 100%; height: 100%; object-fit: contain; }

    .timeline-wrap {
      width: 100%; background: #050505; border-radius: var(--radius);
      border: 1px solid var(--glass-border); height: 120px;
      overflow: hidden; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
    }
    canvas { width: 100%; height: 100%; display: block; cursor: crosshair; }
    .timeline-info {
      display: flex; justify-content: space-between;
      font-size: 10px; color: var(--text-muted); margin-top: 4px; padding: 0 4px;
    }

    .segment-list-container {
      flex: 1; min-height: 120px;
      background: var(--input-bg); border: 1px solid var(--glass-border);
      border-radius: var(--radius); overflow: hidden;
      display: flex; flex-direction: column;
    }
    .segment-list-header {
      padding: 12px 16px; font-size: 12px; color: var(--text-muted);
      background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass-border);
    }
    .segment-list-body { flex: 1; overflow-y: auto; }
    .segment-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 13px; cursor: pointer; transition: 0.1s;
    }
    .segment-row:hover { background: rgba(255,255,255,0.05); }
    .segment-row.inactive { opacity: 0.5; background: rgba(0,0,0,0.1); text-decoration: line-through; }
    .segment-row.inactive .seg-status { color: var(--text-muted); }
    .seg-id { width: 40px; color: var(--text-muted); }
    .seg-time { flex: 1; color: var(--text-main); }
    .seg-status { font-weight: 600; color: var(--primary); font-size: 16px; }
    
    .btn {
      width: 100%; padding: 16px; border: none; border-radius: 14px;
      font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 10px; letter-spacing: 0.02em;
    }
    .btn-primary { 
      background: var(--primary); color: #050505; 
      box-shadow: 0 4px 20px rgba(141, 194, 31, 0.2);
    }
    .btn-primary:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); }
    .btn-primary:disabled { background: var(--input-bg); color: var(--text-muted); cursor: not-allowed; box-shadow: none; }
    
    .btn-secondary { 
      background: var(--input-bg); color: var(--text-main); border: 1px solid var(--glass-border); padding: 12px;
    }
    .btn-secondary:hover { background: var(--glass-border); }
    .btn-danger { color: var(--danger); border-color: rgba(255, 92, 92, 0.3); }
    .btn-danger:hover { background: rgba(255, 92, 92, 0.1); }

    /* ã‚«ãƒƒãƒˆå¾Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’ã‚ã‹ã‚Šã‚„ã™ã */
    .cut-preview-btn {
      min-width: 220px;
      justify-content: flex-start;
    }
    .cut-preview-btn.playing {
      color: var(--danger);
      border-color: rgba(255, 92, 92, 0.4);
    }

    .export-section {
      background: var(--glass-bg); backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border); border-radius: var(--radius); padding: 20px; margin-top: auto;
    }
    
    .format-select {
      width: 100%; padding: 12px; border-radius: 12px;
      background: var(--input-bg); border: 1px solid var(--glass-border);
      color: var(--text-main); font-size: 14px; font-weight: 600;
      margin-bottom: 12px; cursor: pointer; outline: none;
    }
    .format-select option { background: #222; color: #fff; }

    .progress-bar {
      height: 8px; background: var(--glass-border);
      border-radius: 4px; margin: 12px 0; overflow: hidden;
    }
    .progress-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.2s; }
    
    #downloadBtn {
      display: none; text-decoration: none; text-align: center; 
      background: rgba(74, 163, 255, 0.15); color: var(--accent);
      padding: 14px; border-radius: 12px; font-size: 14px; font-weight: 700;
      margin-top: 12px; transition: 0.2s;
    }
    #downloadBtn:hover { background: rgba(74, 163, 255, 0.25); }

    .log-console {
      font-family: var(--font-mono); font-size: 10px; color: var(--text-muted);
      background: rgba(0, 0, 0, 0.3); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 12px; height: 100px;
      overflow-y: auto; margin-top: auto; line-height: 1.4;
    }

    /* --- Help Modal (Liquid Glass Style) --- */
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .modal-overlay {
      position: fixed; inset: 0; z-index: 1000;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.086) 0%, rgba(118, 75, 162, 0.09) 25%, rgba(240, 147, 251, 0.09) 50%, rgba(245, 87, 108, 0.09) 75%, rgba(79, 172, 254, 0.09) 100%);
      background-size: 400% 400%; animation: gradientShift 15s ease infinite;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
      perspective: 1000px; backdrop-filter: blur(10px);
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    .modal-card {
      width: 90%; max-width: 600px; max-height: 85vh;
      background: rgba(27, 27, 27, 0.6);
      backdrop-filter: blur(20px) saturate(1.8); -webkit-backdrop-filter: blur(20px) saturate(1.8);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 24px; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      color: #ffffff; display: flex; flex-direction: column;
      transform: translateZ(0) scale(0.9) rotateX(10deg);
      opacity: 0; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal-overlay.open .modal-card { transform: translateZ(0) scale(1) rotateX(0deg); opacity: 1; }
    .modal-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.1) 100%);
      opacity: 0.5; pointer-events: none; z-index: 0;
    }
    .modal-header {
      padding: 24px 30px; border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1;
    }
    .modal-header h2 { 
      margin: 0; font-size: 22px; font-weight: 700; 
      background: linear-gradient(45deg, #ffffff, #e0e0e0);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .close-btn {
      background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3);
      color: #fff; width: 32px; height: 32px; border-radius: 50%;
      font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease;
    }
    .close-btn:hover { background: rgba(255, 255, 255, 0.3); transform: rotate(90deg); }
    .modal-body {
      padding: 30px; overflow-y: auto; font-size: 15px; line-height: 1.7; position: relative; z-index: 1;
    }
    .modal-body::-webkit-scrollbar { width: 6px; }
    .modal-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
    .modal-body h3 { margin-top: 0; color: #fff; font-size: 18px; border-left: 4px solid rgba(255,255,255,0.8); padding-left: 12px; margin-bottom: 12px; }
    .modal-body h4 { margin: 16px 0 8px; color: #fff; font-size: 15px; font-weight: 700; opacity: 0.9; }
    .modal-body p { margin: 0 0 12px; color: rgba(255,255,255,0.9); }
    .modal-body ul { padding-left: 20px; color: rgba(255,255,255,0.85); margin-bottom: 12px; }
    .modal-body strong { color: #fff; font-weight: 700; text-decoration: underline decoration-thickness 1px; text-underline-offset: 2px; }
  </style>
</head>
<body class="light-mode">

  <div class="bg-orb"></div>

  <header>
    <div class="header-inner">
      <div class="logo">
        <!-- SVG Logo -->
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 266 44">
          <style>.st0{fill:#C0CD7D;}.st1{fill:#8DC21F;}.st2{fill:#1D412C;}.st3{fill:#45855B;}.st4{fill:#A9CD36;}.st5{fill:#595757;}.st6{fill:#006134;}</style>
          <g><g><polygon class="st0" points="26,16.6 9.7,16.6 22.8,26.2"/><polygon class="st1" points="46.7,43.5 38,16.6 32.6,14.7 27.2,16.6 18.4,43.5 32.6,33.4"/><polygon class="st0" points="46.7,43.5 38,16.6 32.6,14.7 32.6,33.4"/><polygon class="st2" points="32.6,14.7 38,16.6 32.6,0 27.2,16.6"/><polygon class="st3" points="32.6,14.7 38,16.6 32.6,0"/><g><polygon class="st4" points="55.4,16.6 39.2,16.6 42.3,26.2"/></g></g><g><polygon class="st5" points="192.3,5.2 189.7,5.2 189.4,9.7 192.1,9.7"/><polygon class="st5" points="196.4,5.3 193.8,5.3 193.6,9.7 196.2,9.7"/></g><polygon class="st5" points="257.9,21.2 256.6,21.2 256.3,21.2 254.6,21.2 231.2,21.2 230.9,26.2 256.3,26.2 256.3,26.2"/><path class="st5" d="M102.8,8.5l-1.6,4.9h23c-1.1,4.5-3.9,7.2-8.4,8.5c0.2-1.2,0.3-2.2,0.4-3.4l0.1-2.4h-5l-0.1,2.2c-0.4,7.6-2.8,12-9.2,14.4l-0.2,0.1l-0.3,4.9l0.3-0.1c6.1-1.6,9.8-5,12.2-10.1c5.6-1,15-4.6,16.2-17.8l0.1-1.1C130.2,8.5,105.3,8.5,102.8,8.5z"/><path class="st5" d="M147.8,12.7l0.3-5.5h-5.2l-0.3,5.5h-7.4l-1.5,4.8h8.7c-0.6,6.5-3.9,11.8-9.4,14.9l-0.1,0.1l-0.3,5.2l0.3-0.1c8.2-2.9,13.5-10.2,14.6-20h9.2l-0.6,11.3c-0.1,2.6-1.1,3.5-3.7,3.5h-4.3l-1.6,4.8h6.6c5.4,0,8-2.5,8.3-8l0.9-16.4H147.8z"/><g><path class="st5" d="M168.8,17.4l-1.5,4.7h14.4c-1.1,5.7-5.6,9.4-12,10.4l-0.2,0l-0.3,4.9l0.3,0c6.8-0.9,15.7-4.3,17.8-15.4h10.3l0.2-4.7H168.8z"/><polygon class="st5" points="187.9,11.2 188,8.5 171.9,8.5 170.5,12.9 170.4,13.3 196,13.3 196.1,11.2"/></g><g><path class="st5" d="M226.4,10.2c-7.2-0.9-15.5-1.3-23.2-1.5l-1.5,4.6c8.5,0.1,15.7,0.6,24.4,1.6L226.4,10.2z"/><path class="st5" d="M224.7,21.2c-7.2-1.1-13.8-1.4-20.2-1.6L203,24c7.4,0.2,13.8,0.7,21.4,1.8L224.7,21.2z"/><path class="st5" d="M201.2,30.5l-1.5,4.6c8.9,0.3,18,1.2,26.9,2.8l0.3-4.8C218.3,31.6,210,30.8,201.2,30.5z"/></g><path class="st6" d="M64.8,37.6l1.5-4.7h21.2c1-0.1,1.8-0.4,2.5-1.1c0.6-0.8,1-1.7,1-2.7c0-1-0.3-1.9-1-2.7c-0.7-0.8-1.5-1.2-2.5-1.2H71.7c-1.9,0-3.5-0.8-4.9-2.4c-1.4-1.7-2.1-3.6-2.1-6c0-2.4,0.7-4.3,2.1-5.9c1.4-1.6,3-2.4,5-2.5h23.6l-1.6,4.9H72.9c0,0-0.1,0-0.2,0c-0.6,0-1.4,0.2-2.2,1.1c-0.5,0.6-0.8,1.4-0.8,2.4c0,0.9,0.3,1.7,0.9,2.4c0.6,0.7,1.4,1.1,2.3,1.1h15.3c2,0,3.6,0.8,5,2.4c1.5,1.7,2.2,3.7,2.2,6.2c0,2.5-0.7,4.5-2.2,6.2c-1.4,1.7-3.1,2.5-5.1,2.5L64.8,37.6L64.8,37.6z"/></svg>
      </div>
      
      <div style="display:flex; gap:12px; align-items:center;">
        <button id="helpBtn" class="theme-toggle" title="ä½¿ã„æ–¹">
          <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
        </button>
        <button id="themeToggle" class="theme-toggle" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">
          <svg id="iconMoon" class="icon" viewBox="0 0 24 24" style="display:none;"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
          <svg id="iconSun" class="icon" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000 1.41.996.996 0 001.41 0l1.06-1.06c.39-.39.39-1.03 0-1.41s-1.03-.39-1.41 0l-1.06 1.06z"/></svg>
        </button>
      </div>
    </div>
  </header>

  <main>
    <!-- Left Panel -->
    <div class="panel-left">
      
      <label class="drop-zone">
        <input type="file" id="fileInput" accept="video/*,audio/*" style="display:none;">
        <div class="drop-zone-icon">
          <svg class="icon-lg" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
        </div>
        <div class="drop-zone-text">å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div style="font-size:12px; color:var(--text-muted); margin-top:6px;">ã‚¿ãƒƒãƒ— ã¾ãŸã¯ ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
      </label>

      <div class="stats-card">
        <div class="stat-item">
          <span class="stat-label">å…ƒå‹•ç”»</span>
          <span class="stat-value" id="statOriginal">--:--</span>
        </div>
        <div class="stat-arrow">
          <svg class="icon" viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
        </div>
        <div class="stat-item">
          <span class="stat-label">ã‚«ãƒƒãƒˆå¾Œ</span>
          <span class="stat-value" id="statNew" style="color:var(--primary);">--:--</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">çŸ­ç¸®ç‡</span>
          <span class="stat-saving" id="statSaving"></span>
        </div>
      </div>

      <div class="control-group">
        <h2>
          <svg class="icon" viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>
          ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´
        </h2>
        
        <div class="slider-item">
          <div class="slider-header">
            <span>ã—ãã„å€¤ (Threshold)</span>
            <!-- åˆæœŸå€¤ã‚’ -48 dB ã«å¤‰æ›´ -->
            <span class="label-val" id="thresholdVal">-48 dB</span>
          </div>
          <div class="slider-desc">ã“ã®å€¤ã‚ˆã‚Šå°ã•ã„éŸ³ã‚’ã€Œç„¡éŸ³ã€ã¨ã¿ãªã—ã¦ã‚«ãƒƒãƒˆã—ã¾ã™ã€‚</div>
          <input type="range" id="threshold" min="-60" max="-10" value="-48" step="1">
        </div>

        <div class="slider-item">
          <div class="slider-header">
            <span>æœ€çŸ­ç™ºè©±æ™‚é–“</span>
            <span class="label-val" id="minDurationVal">0.3 s</span>
          </div>
          <div class="slider-desc">ã“ã‚Œã‚ˆã‚ŠçŸ­ã„éŸ³ã¯ãƒã‚¤ã‚ºã¨ã¿ãªã—ã¦ç„¡è¦–ã—ã¾ã™ã€‚</div>
          <input type="range" id="minDuration" min="0.1" max="2.0" value="0.3" step="0.1">
        </div>

        <div class="slider-item">
          <div class="slider-header">
            <span>å‰å¾Œã®ä½™ç™½</span>
            <span class="label-val" id="paddingVal">0.1 s</span>
          </div>
          <div class="slider-desc">ãƒ–ãƒ„åˆ‡ã‚Šæ„Ÿã‚’é˜²ããŸã‚ã€ã‚«ãƒƒãƒˆåŒºé–“ã®å‰å¾Œã«ä½™éŸ»ã‚’æ®‹ã—ã¾ã™ã€‚</div>
          <input type="range" id="padding" min="0.0" max="1.0" value="0.1" step="0.05">
        </div>

        <button id="analyzeBtn" class="btn btn-primary" style="margin-top:24px;" disabled>
          <svg class="icon icon-btn" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          éŸ³é‡ã‚’è§£æ
        </button>
      </div>
      
      <!-- Log Console -->
      <div class="log-console" id="logConsole">System Ready...</div>
    </div>

    <!-- Right Panel -->
    <div class="panel-right">
      
      <div class="preview-container">
        <video id="previewPlayer" playsinline controls preload="auto"></video>

      </div>

      <div>
        <div class="timeline-wrap">
          <canvas id="waveformCanvas" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚·ãƒ¼ã‚¯"></canvas>
        </div>
        <div class="timeline-info">
          <span>Waveform (Green: Active)</span>
          <span>Timeline Navigation</span>
        </div>
      </div>
      
      <!-- Segment List -->
      <div class="segment-list-container">
        <div class="segment-list-header">
          æ¤œå‡ºã•ã‚ŒãŸç™ºè©±åŒºé–“ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ON/OFFåˆ‡æ›¿ï¼‰
        </div>
        <div id="segmentListBody" class="segment-list-body">
          <div style="padding:20px; text-align:center; color:#888;">è§£æå¾…ã¡...</div>
        </div>
      </div>

      <div style="display:flex; gap:16px; flex-wrap:wrap;">
        <!-- æœ€åˆã¯ã“ã®ãƒœã‚¿ãƒ³ã®ã¿è¡¨ç¤º -->
        <button id="smoothPreviewBtn" class="btn btn-secondary">
          <svg class="icon icon-btn" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
        </button>
        <!-- ç”Ÿæˆå¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ã€å†ç”Ÿ / åœæ­¢ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
        <button id="cutPreviewToggleBtn" class="btn btn-secondary cut-preview-btn" style="display:none;">
          <svg class="icon icon-btn" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          ã‚«ãƒƒãƒˆå¾Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ
        </button>
      </div>

      <!-- Export Section -->
      <div class="export-section">
        <select id="exportFormat" class="format-select">
          <option value="mp4">ğŸ¬ å‹•ç”»æ›¸ãå‡ºã— (.mp4)</option>
          <option value="audio">ğŸ”Š éŸ³å£°ã®ã¿æ›¸ãå‡ºã— (.m4a)</option>
          <option value="xml">ğŸ“ ç·¨é›†ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãå‡ºã— (.edl / XML)</option>
        </select>
      
        <div style="display:flex; gap:10px;">
          <button id="exportBtn" class="btn btn-primary" disabled>
            <svg class="icon icon-btn" viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>
            æ›¸ãå‡ºã— & è‡ªå‹•ä¿å­˜
          </button>
          <button id="cancelBtn" class="btn btn-danger" style="display:none; width:auto;">
            ä¸­æ­¢
          </button>
        </div>
        
        <div class="progress-bar">
          <div id="exportProgress" class="progress-fill"></div>
        </div>
        <div id="exportStatus" style="font-size:13px; color:var(--text-muted); text-align:center; min-height:20px;"></div>
        
        <a id="downloadBtn" href="#" download>
          <svg class="icon icon-btn" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
          æ‰‹å‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </a>
      </div>

    </div>
  </main>

  <!-- Help Modal -->
  <div id="helpModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <h2>ä½¿ã„æ–¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h2>
        <button id="closeHelp" class="close-btn">Ã—</button>
      </div>
      <div class="modal-body">
        <h3>1. ã¯ã˜ã‚ã«</h3>
        <p>å‹•ç”»ã‚„éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã€Œç„¡éŸ³ã€ã‚’è‡ªå‹•æ¤œå‡ºã—ã¦ã‚«ãƒƒãƒˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å‡¦ç†ã¯ã™ã¹ã¦ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è¡Œã‚ã‚Œã¾ã™ã€‚</p>
        
        <h3>2. æ–°æ©Ÿèƒ½ (Pro)</h3>
        <ul>
          <li><strong>å€‹åˆ¥ã‚«ãƒƒãƒˆç·¨é›†:</strong> ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®åŒºé–“ã‚’ä½¿ã†ã‹æ¨ã¦ã‚‹ã‹ã‚’æ‰‹å‹•ã§åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</li>
          <li><strong>XMLæ›¸ãå‡ºã—:</strong> ã€Œç·¨é›†ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãå‡ºã—ã€ã‚’é¸ã¶ã¨ã€Premiere Proã‚„DaVinci Resolveç”¨ã®EDLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€ç¬ã§ä½œæˆã—ã¾ã™ã€‚ç”»è³ªåŠ£åŒ–ãªã—ã§æœ€å¼·ã§ã™ã€‚</li>
          <li><strong>éŸ³å£°ã®ã¿:</strong> ä¼šè­°ã®è­°äº‹éŒ²ç”¨ã«éŸ³å£°ã ã‘ã‚’è»½ãæ›¸ãå‡ºã›ã¾ã™ã€‚</li>
        </ul>

        <h3>3. åŸºæœ¬æ‰‹é †</h3>
        <h4>ã‚¹ãƒ†ãƒƒãƒ—1ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</h4>
        <p>å·¦ä¸Šã®ã‚¨ãƒªã‚¢ã«å‹•ç”»ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
        <h4>ã‚¹ãƒ†ãƒƒãƒ—2ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´</h4>
        <p>ã—ãã„å€¤ã‚„ç™ºè©±æ™‚é–“ã‚’èª¿æ•´ã—ã€ŒéŸ³é‡ã‚’è§£æã€ã‚’æŠ¼ã—ã¾ã™ã€‚</p>
        <h4>ã‚¹ãƒ†ãƒƒãƒ—3ï¼šæ›¸ãå‡ºã—</h4>
        <p>å½¢å¼ï¼ˆå‹•ç”»/éŸ³å£°/ç·¨é›†ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’é¸ã‚“ã§ã€Œæ›¸ãå‡ºã—ã€ã‚’æŠ¼ã—ã¾ã™ã€‚</p>

        <h3>4. ã‚³ãƒ¼ãƒ‰æ”¹å¤‰ã«é–¢ã—ã¦</h3>
        <p>æœ¬ã‚¢ãƒ—ãƒªã¯Githubã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´åˆã«ã¯ç°¡å˜ã«ã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ›ãˆãŒå¯èƒ½ã§ã™ã€‚ã‚‚ã—ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç­‰ã‚’è¡Œã†éš›ã«ã¯å¿…ãšæ›¸ãæ›ãˆå‰ã®çŠ¶æ…‹ã‚’ã™ãã«å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ä¸‹ã•ã„ã€‚</p>
        <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ã™ã¹ã¦äº•å£ãƒ•ã‚©ãƒ«ãƒ€å†…ã€ŒMutecutã€ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿ç®¡ã—ã¦ã„ã¾ã™ã€‚</p>
      </div>
    </div>
  </div>

<script>
  // --- Modal & Theme ---
  const helpBtn = document.getElementById('helpBtn');
  const helpModal = document.getElementById('helpModal');
  const closeHelp = document.getElementById('closeHelp');
  helpBtn.onclick = () => helpModal.classList.add('open');
  closeHelp.onclick = () => helpModal.classList.remove('open');
  helpModal.onclick = (e) => { if (e.target === helpModal) helpModal.classList.remove('open'); };

  const themeToggle = document.getElementById('themeToggle');
  const iconSun = document.getElementById('iconSun');
  const iconMoon = document.getElementById('iconMoon');
  let isDarkMode = false;
  themeToggle.onclick = () => {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('light-mode', !isDarkMode);
    iconSun.style.display = isDarkMode ? 'none' : 'block';
    iconMoon.style.display = isDarkMode ? 'block' : 'none';
    if (audioBuffer) drawWaveform(audioBuffer.getChannelData(0));
  };

  // --- Core Elements ---
  const fileInput = document.getElementById('fileInput');
  const previewPlayer = document.getElementById('previewPlayer');
  const waveformCanvas = document.getElementById('waveformCanvas');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const exportBtn = document.getElementById('exportBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const exportFormat = document.getElementById('exportFormat');
  const smoothPreviewBtn = document.getElementById('smoothPreviewBtn');
  const cutPreviewToggleBtn = document.getElementById('cutPreviewToggleBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const exportProgress = document.getElementById('exportProgress');
  const exportStatus = document.getElementById('exportStatus');
  const logConsole = document.getElementById('logConsole');
  const segmentListBody = document.getElementById('segmentListBody');

  // Stats
  const statOriginal = document.getElementById('statOriginal');
  const statNew = document.getElementById('statNew');
  const statSaving = document.getElementById('statSaving');

  // Sliders
  const sThreshold = document.getElementById('threshold');
  const sMinDur = document.getElementById('minDuration');
  const sPadding = document.getElementById('padding');

  // --- State ---
  let ffmpeg = null;
  let audioBuffer = null;
  let rawFile = null;
  let rawFileOriginal = null;
  let detectedSegments = []; // {start, end, isActive}
  let hasSmoothPreview = false;
  let isCutPreviewPlaying = false;
  let isProcessing = false;         // FFmpegå‡¦ç†ä¸­ãƒ•ãƒ©ã‚°ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ / ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå…±æœ‰ï¼‰
  let previewUrl = null;            // ã‚«ãƒƒãƒˆå¾Œè»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã® URL

  const log = (msg) => {
    const t = new Date().toLocaleTimeString();
    logConsole.innerText = `[${t}] ${msg}\n` + logConsole.innerText;
  };

  const formatTime = (sec) => {
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
  };

  const updateSliderUI = (id, val, unit) =>
    document.getElementById(id + 'Val').innerText = val + unit;

  // è§£æä¸­ / ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­ã¯ã“ã“ã§ãƒ­ãƒƒã‚¯
  function setControlsLocked(lock) {
    [sThreshold, sMinDur, sPadding].forEach(el => el.disabled = lock);
    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ã¨ãã¯è§£æãƒœã‚¿ãƒ³ã¯æŠ¼ã›ãªã„
    analyzeBtn.disabled = lock || !rawFile;
    // audioBuffer ãŒãªã„é–“ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã¯æŠ¼ã›ãªã„
    smoothPreviewBtn.disabled = lock || !audioBuffer;
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿãƒœã‚¿ãƒ³ã¯ã€ç”Ÿæˆæ¸ˆã¿ã‹ã¤ãƒ­ãƒƒã‚¯ã—ã¦ã„ãªã„ã¨ãã ã‘
    cutPreviewToggleBtn.disabled = lock || !hasSmoothPreview;
  }

  [sThreshold, sMinDur, sPadding].forEach(el => {
    el.addEventListener('input', () => {
      updateSliderUI(el.id, el.value, el.id === 'threshold' ? ' dB' : ' s');
      if (audioBuffer) drawWaveform(audioBuffer.getChannelData(0));
    });
    el.addEventListener('change', () => {
      if (audioBuffer) {
        detectSilence();
        if (hasSmoothPreview) {
          exportStatus.innerText = 'ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚';
        }
      }
    });
  });

  // Initialize FFmpeg
  const initFFmpeg = async () => {
    if (ffmpeg) return;
    const { createFFmpeg } = FFmpeg;
    ffmpeg = createFFmpeg({
      log: false,
      corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
      progress: ({ ratio }) => {
        if (ratio >= 0 && ratio <= 1 && isProcessing) {
          exportProgress.style.width = `${ratio * 100}%`;
          exportStatus.innerText = `å‡¦ç†ä¸­... ${Math.round(ratio * 100)}%`;
        }
      }
    });
    await ffmpeg.load();
  };

  // --- File Input ---
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    rawFileOriginal = file;
    rawFile = file;

    // ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚’ãã®ã¾ã¾ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã“ã®æ®µéšã§ã¯ã‚«ãƒƒãƒˆå‰ï¼‰
    previewPlayer.src = URL.createObjectURL(file);

    // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
    audioBuffer = null;
    detectedSegments = [];
    hasSmoothPreview = false;
    isCutPreviewPlaying = false;
    isProcessing = false;

    exportBtn.disabled = true;
    downloadBtn.style.display = 'none';
    cutPreviewToggleBtn.style.display = 'none';
    cutPreviewToggleBtn.disabled = true;

    analyzeBtn.disabled = false;
    smoothPreviewBtn.disabled = true;  // è§£æãŒçµ‚ã‚ã‚‹ã¾ã§ã¯æŠ¼ã›ãªã„

    statOriginal.innerText = '--:--';
    statNew.innerText = '--:--';
    statSaving.innerText = '';

    segmentListBody.innerHTML =
      '<div style="padding:20px; text-align:center; color:#888;">è§£æå¾…ã¡...</div>';

    const ctx = waveformCanvas.getContext('2d');
    ctx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);

    document.querySelector('.drop-zone-text').innerText = file.name;
    log(`File Selected: ${file.name}`);
    exportStatus.innerText = '';
    exportProgress.style.width = '0%';

    setControlsLocked(false);
  });

  // --- éŸ³é‡è§£æ ï¼‹ åˆå›è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ ---
  analyzeBtn.addEventListener('click', async () => {
    if (!rawFile) return;
    if (isProcessing) return;

    setControlsLocked(true);
    exportStatus.innerText = 'è§£æä¸­...';
    exportProgress.style.width = '0%';
    log('è§£æã‚’é–‹å§‹...');

    try {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      if (!audioBuffer) {
        try {
          const ab = await rawFile.arrayBuffer();
          audioBuffer = await audioCtx.decodeAudioData(ab.slice(0));
        } catch (e) {
          log('FFmpegã§éŸ³å£°æŠ½å‡ºä¸­...');
          audioBuffer = await decodeWithFFmpeg(rawFile, audioCtx);
        }
      }

      detectSilence();
      log('è§£æå®Œäº†ã€‚è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã—ã¾ã™...');
      exportStatus.innerText = 'è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆä¸­...';

      await generateSmoothPreview();   // è§£æå®Œäº†ã¨åŒæ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ

      exportStatus.innerText = 'è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚';
    } catch (e) {
      console.error(e);
      log('è§£æ / ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + e.message);
      exportStatus.innerText = 'è§£æã¾ãŸã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
    } finally {
      setControlsLocked(false);
      exportProgress.style.width = '0%';
    }
  });

  async function decodeWithFFmpeg(file, audioCtx) {
    if (!ffmpeg) await initFFmpeg();
    const { fetchFile } = FFmpeg;
    ffmpeg.FS('writeFile', 'temp.mov', await fetchFile(file));
    await ffmpeg.run(
      '-i', 'temp.mov',
      '-vn', '-acodec', 'pcm_s16le',
      '-ar', '44100', '-ac', '1',
      'out.wav'
    );
    const data = ffmpeg.FS('readFile', 'out.wav');
    ffmpeg.FS('unlink', 'temp.mov');
    ffmpeg.FS('unlink', 'out.wav');
    return await audioCtx.decodeAudioData(data.buffer);
  }

  // --- ç„¡éŸ³æ¤œå‡º ---
  function detectSilence() {
    if (!audioBuffer) return;
    const rawData = audioBuffer.getChannelData(0);
    const sr = audioBuffer.sampleRate;
    const thDB = parseFloat(sThreshold.value);
    const minDur = parseFloat(sMinDur.value);
    const pad = parseFloat(sPadding.value);
    const winSize = Math.floor(sr * 0.05);

    const segments = [];
    let isSpeaking = false;
    let startFrame = 0;

    for (let i = 0; i < rawData.length; i += winSize) {
      let sum = 0;
      const end = Math.min(i + winSize, rawData.length);
      for (let j = i; j < end; j++) sum += rawData[j] * rawData[j];
      const db = 20 * Math.log10(Math.sqrt(sum / (end - i)) || 1e-8);
      const isLoud = db > thDB;
      if (isLoud && !isSpeaking) {
        isSpeaking = true;
        startFrame = i;
      } else if (!isLoud && isSpeaking) {
        isSpeaking = false;
        segments.push({ start: startFrame / sr, end: i / sr });
      }
    }
    if (isSpeaking) segments.push({ start: startFrame / sr, end: rawData.length / sr });

    let merged = [];
    if (segments.length > 0) {
      let cur = {
        start: Math.max(0, segments[0].start - pad),
        end: segments[0].end + pad
      };
      for (let k = 1; k < segments.length; k++) {
        const nS = Math.max(0, segments[k].start - pad);
        const nE = segments[k].end + pad;
        if (nS <= cur.end) {
          cur.end = Math.max(cur.end, nE);
        } else {
          if (cur.end - cur.start >= minDur) merged.push(cur);
          cur = { start: nS, end: nE };
        }
      }
      if (cur.end - cur.start >= minDur) merged.push(cur);
    }

    detectedSegments = merged.map(s => ({
      start: Math.max(0, s.start),
      end: Math.min(audioBuffer.duration, s.end),
      isActive: true
    }));

    updateUIState();
  }

  // --- UI æ›´æ–° ---
  function updateUIState() {
    if (!audioBuffer) return;
    drawWaveform(audioBuffer.getChannelData(0));
    renderSegmentList();

    const orig = audioBuffer.duration;
    let newDur = 0;
    detectedSegments.forEach(s => {
      if (s.isActive) newDur += (s.end - s.start);
    });

    statOriginal.innerText = formatTime(orig);
    statNew.innerText = formatTime(newDur);
    const saved = orig - newDur;
    statSaving.innerText = `-${orig > 0 ? Math.round((saved / orig) * 100) : 0}%`;

    const valid = detectedSegments.some(s => s.isActive);
    exportBtn.disabled = !valid;

    if (hasSmoothPreview) {
      cutPreviewToggleBtn.disabled = !valid;
    }
  }

  function drawWaveform(data) {
    const ctx = waveformCanvas.getContext('2d');
    const w = waveformCanvas.width = waveformCanvas.offsetWidth;
    const h = waveformCanvas.height = waveformCanvas.offsetHeight;
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#080808';
    ctx.fillRect(0, 0, w, h);

    let maxAmp = 0;
    for (let i = 0; i < data.length; i += 100) {
      const v = Math.abs(data[i]);
      if (v > maxAmp) maxAmp = v;
    }
    const scale = (h / 2) * 0.9 / (maxAmp || 1);
    const step = Math.ceil(data.length / w);

    ctx.beginPath();
    ctx.strokeStyle = '#444';
    ctx.lineWidth = 1;
    for (let x = 0; x < w; x++) {
      const val = data[x * step] || 0;
      const y = val * scale;
      ctx.moveTo(x, h / 2 - y);
      ctx.lineTo(x, h / 2 + y);
    }
    ctx.stroke();

    const totalSec = data.length / audioBuffer.sampleRate;
    detectedSegments.forEach(s => {
      const x = (s.start / totalSec) * w;
      const wid = ((s.end - s.start) / totalSec) * w;
      ctx.fillStyle = s.isActive ? 'rgba(141,194,31,0.3)' : 'rgba(255,50,50,0.1)';
      ctx.fillRect(x, 0, wid, h);
    });

    const thVal = parseFloat(sThreshold.value);
    const ratio = (thVal - (-60)) / 50;
    const ly = h / 2 - (h / 2 * ratio);
    ctx.beginPath();
    ctx.strokeStyle = '#4aa3ff';
    ctx.setLineDash([4, 4]);
    ctx.moveTo(0, ly);
    ctx.lineTo(w, ly);
    ctx.moveTo(0, h - ly);
    ctx.lineTo(w, h - ly);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  function renderSegmentList() {
    segmentListBody.innerHTML = '';
    detectedSegments.forEach((s, idx) => {
      const div = document.createElement('div');
      div.className = `segment-row ${s.isActive ? '' : 'inactive'}`;
      div.innerHTML = `
        <span class="seg-id">#${idx + 1}</span>
        <span class="seg-time">${s.start.toFixed(2)}s - ${s.end.toFixed(2)}s</span>
        <span class="seg-status">${s.isActive ? 'âœ”' : 'âœ–'}</span>
      `;
      div.onclick = () => {
        s.isActive = !s.isActive;
        updateUIState();
      };
      segmentListBody.appendChild(div);
    });
  }

  // --- è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆï¼ˆã‚«ãƒƒãƒˆå¾Œã€ä½ç”»è³ªï¼‰ ---
  async function generateSmoothPreview() {
    const activeSegs = detectedSegments.filter(s => s.isActive);
    if (!rawFile || !activeSegs.length) {
      log('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }

    if (!ffmpeg) await initFFmpeg();

    isProcessing = true;
    exportProgress.style.width = '0%';

    try {
      const { fetchFile } = FFmpeg;
      log('ä½ç”»è³ªè»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆé–‹å§‹...');
      ffmpeg.FS('writeFile', 'preview_in.src', await fetchFile(rawFile));

      let filter = '';
      const segCount = activeSegs.length;

      activeSegs.forEach((s, i) => {
        filter += `[0:v]trim=start=${s.start}:end=${s.end},setpts=PTS-STARTPTS[v${i}];`;
        filter += `[0:a]atrim=start=${s.start}:end=${s.end},asetpts=PTS-STARTPTS[a${i}];`;
      });

      const vLabels = activeSegs.map((_, i) => `[v${i}]`).join('');
      const aLabels = activeSegs.map((_, i) => `[a${i}]`).join('');

      filter += `${vLabels}concat=n=${segCount}:v=1:a=0[vcat];`;
      filter += `[vcat]scale=640:-2[vout];`;
      filter += `${aLabels}concat=n=${segCount}:v=0:a=1[aout]`;

      const outName = 'preview.mp4';
      const args = [
        '-i', 'preview_in.src',
        '-filter_complex', filter,
        '-map', '[vout]',
        '-map', '[aout]',
        '-r', '24',
        '-c:v', 'libx264',
        '-preset', 'ultrafast',
        '-crf', '30',
        '-c:a', 'aac',
        outName
      ];

      await ffmpeg.run(...args);

      const data = ffmpeg.FS('readFile', outName);
      ffmpeg.FS('unlink', 'preview_in.src');
      ffmpeg.FS('unlink', outName);

      if (previewUrl) {
        URL.revokeObjectURL(previewUrl);
      }

      previewUrl = URL.createObjectURL(
        new Blob([data.buffer], { type: 'video/mp4' })
      );

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚«ãƒƒãƒˆå¾Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
      previewPlayer.src = previewUrl;
      previewPlayer.currentTime = 0;
      isCutPreviewPlaying = false;

      hasSmoothPreview = true;
      cutPreviewToggleBtn.style.display = 'inline-flex';
      cutPreviewToggleBtn.disabled = false;
      updateCutPreviewButtonUI();

      log('ä½ç”»è³ªè»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
    } catch (e) {
      console.error(e);
      log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + e.message);
      exportStatus.innerText = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
    } finally {
      isProcessing = false;
      exportProgress.style.width = '0%';
    }
  }

  // ã€Œè»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ / å†ç”Ÿæˆã€ãƒœã‚¿ãƒ³
  smoothPreviewBtn.addEventListener('click', async () => {
    if (!audioBuffer || !detectedSegments.some(s => s.isActive)) {
      log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”ŸæˆãŒã§ãã¾ã›ã‚“ï¼ˆè§£æãŒå®Œäº†ã—ã¦ã„ãªã„ã‹ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ï¼‰');
      return;
    }
    if (isProcessing) return;

    setControlsLocked(true);
    exportStatus.innerText = 'è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†ç”Ÿæˆä¸­...';
    exportProgress.style.width = '0%';

    try {
      await generateSmoothPreview();
      exportStatus.innerText = 'è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†ç”Ÿæˆã—ã¾ã—ãŸã€‚';
    } finally {
      setControlsLocked(false);
      exportProgress.style.width = '0%';
    }
  });

  function updateCutPreviewButtonUI() {
    if (!hasSmoothPreview) {
      cutPreviewToggleBtn.style.display = 'none';
      return;
    }
    if (isCutPreviewPlaying) {
      cutPreviewToggleBtn.innerHTML = `
        <svg class="icon icon-btn" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
        ã‚«ãƒƒãƒˆå¾Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åœæ­¢
      `;
      cutPreviewToggleBtn.classList.add('playing');
    } else {
      cutPreviewToggleBtn.innerHTML = `
        <svg class="icon icon-btn" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        ã‚«ãƒƒãƒˆå¾Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ
      `;
      cutPreviewToggleBtn.classList.remove('playing');
    }
  }

  // å†ç”Ÿ / åœæ­¢ãƒˆã‚°ãƒ«
  cutPreviewToggleBtn.addEventListener('click', () => {
    if (!hasSmoothPreview || cutPreviewToggleBtn.disabled) return;
    if (previewPlayer.paused) {
      previewPlayer.play();
      isCutPreviewPlaying = true;
    } else {
      previewPlayer.pause();
      isCutPreviewPlaying = false;
    }
    updateCutPreviewButtonUI();
  });

  // å†ç”Ÿçµ‚äº†æ™‚ã«ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æˆ»ã™
  previewPlayer.addEventListener('ended', () => {
    if (isCutPreviewPlaying) {
      isCutPreviewPlaying = false;
      updateCutPreviewButtonUI();
    }
  });

  // --- Export Handlers ---
  cancelBtn.addEventListener('click', () => {
    location.reload();
  });

  exportBtn.addEventListener('click', async () => {
    const activeSegs = detectedSegments.filter(s => s.isActive);
    if (!rawFile || !activeSegs.length || isProcessing) return;

    isProcessing = true;
    exportBtn.disabled = true;
    cancelBtn.style.display = 'inline-flex';
    exportStatus.innerText = 'æº–å‚™ä¸­...';
    exportProgress.style.width = '0%';

    const format = exportFormat.value;

    if (format === 'xml') {
      downloadXML(activeSegs);
      isProcessing = false;
      exportBtn.disabled = false;
      cancelBtn.style.display = 'none';
      exportStatus.innerText = 'XMLæ›¸ãå‡ºã—å®Œäº†';
      exportProgress.style.width = '0%';
      return;
    }

    if (!ffmpeg) await initFFmpeg();

    try {
      const { fetchFile } = FFmpeg;
      ffmpeg.FS('writeFile', 'in.src', await fetchFile(rawFile));

      let filter = '';
      let maps = '';
      activeSegs.forEach((s, i) => {
        filter += `[0:v]trim=${s.start}:${s.end},setpts=PTS-STARTPTS[v${i}];`;
        filter += `[0:a]atrim=${s.start}:${s.end},asetpts=PTS-STARTPTS[a${i}];`;
        maps += `[v${i}][a${i}]`;
      });
      filter += `${maps}concat=n=${activeSegs.length}:v=1:a=1[out]`;

      let outName = `output.${format === 'audio' ? 'm4a' : 'mp4'}`;
      let args = ['-i', 'in.src', '-filter_complex', filter, '-map', '[out]'];

      if (format === 'audio') {
        filter = '';
        maps = '';
        activeSegs.forEach((s, i) => {
          filter += `[0:a]atrim=${s.start}:${s.end},asetpts=PTS-STARTPTS[a${i}];`;
          maps += `[a${i}]`;
        });
        filter += `${maps}concat=n=${activeSegs.length}:v=0:a=1[outa]`;
        args = ['-i', 'in.src', '-filter_complex', filter, '-map', '[outa]', '-c:a', 'aac', outName];
      } else {
        args.push('-c:v', 'libx264', '-preset', 'ultrafast', '-crf', '23', '-c:a', 'aac', outName);
      }

      log(`ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰é–‹å§‹ (${format})...`);
      await ffmpeg.run(...args);

      exportStatus.innerText = 'ä¿å­˜ä¸­...';
      const data = ffmpeg.FS('readFile', outName);
      const blob = new Blob([data.buffer], { type: format === 'audio' ? 'audio/mp4' : 'video/mp4' });
      const url = URL.createObjectURL(blob);

      downloadBtn.href = url;
      downloadBtn.download = `cut_${rawFile.name}.${format === 'audio' ? 'm4a' : 'mp4'}`;
      downloadBtn.click();
      downloadBtn.style.display = 'block';

      ffmpeg.FS('unlink', 'in.src');
      ffmpeg.FS('unlink', outName);
      log('æ›¸ãå‡ºã—å®Œäº†');
    } catch (e) {
      console.error(e);
      exportStatus.innerText = 'ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ';
      log(e.message);
    } finally {
      isProcessing = false;
      exportBtn.disabled = false;
      cancelBtn.style.display = 'none';
      exportProgress.style.width = '0%';
    }
  });

  // XML / EDL Generator
  function downloadXML(segments) {
    let edl = `TITLE: CUT_PROJECT\nFCM: NON-DROP FRAME\n`;
    let content = edl;
    let recIn = 0;

    const toTC = (t) => {
      const h = Math.floor(t / 3600); t %= 3600;
      const m = Math.floor(t / 60); t %= 60;
      const sec = Math.floor(t);
      const ff = Math.floor((t - sec) * 30);
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}:${String(ff).padStart(2, '0')}`;
    };

    segments.forEach((s, i) => {
      const id = (i + 1).toString().padStart(3, '0');
      const srcInSec = s.start;
      const srcOutSec = s.end;
      const dur = srcOutSec - srcInSec;

      content += `${id}  AX       V     C        ${toTC(srcInSec)} ${toTC(srcOutSec)} ${toTC(recIn)} ${toTC(recIn + dur)}\n`;
      content += `${id}  AX       A     C        ${toTC(srcInSec)} ${toTC(srcOutSec)} ${toTC(recIn)} ${toTC(recIn + dur)}\n`;
      recIn += dur;
    });

    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cut_project.edl';
    a.click();
    log('EDLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
  }

  // Waveformã‚¯ãƒªãƒƒã‚¯ã§ã‚·ãƒ¼ã‚¯ï¼ˆè§£ææ¸ˆã¿ã®ã¨ãï¼‰
  waveformCanvas.addEventListener('click', (e) => {
    if (!audioBuffer) return;
    const r = waveformCanvas.getBoundingClientRect();
    const ratio = (e.clientX - r.left) / r.width;
    previewPlayer.currentTime = ratio * audioBuffer.duration;
  });
</script>

</body>
</html>
