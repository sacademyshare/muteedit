<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç„¡éŸ³åŒºé–“ã‚ªãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆGitHub Pages / ffmpeg.wasmï¼‰</title>
  <style>
    :root{
      --bg:#0b0d10;
      --panel:#12161b;
      --muted:#8aa0b2;
      --text:#eaf2f9;
      --accent:#4aa3ff;
      --accent-2:#6ce1a6;
      --warn:#ffb86b;
      --err:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans","Noto Sans JP",Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 20px;
      border-bottom:1px solid #1f2831;
      background:linear-gradient(180deg,#0d1117,#0a0e13);
    }
    h1{font-size:18px;margin:0}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    video{
      width:100%;
      max-height:320px;
      background:#0c1116;
      border:1px solid #1e2a34;
      border-radius:10px;
      display:block;
    }
    .card{
      background:var(--panel);
      border:1px solid #1e2a34;
      border-radius:14px;
      box-shadow:0 4px 24px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0;
      padding:14px 16px;
      border-bottom:1px solid #1e2a34;
      font-size:16px;
    }
    .card .body{padding:14px 16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label{font-weight:600;color:#d5e2ee}
    input[type="file"]{
      padding:10px;
      border:1px dashed #2a3a47;
      border-radius:10px;
      background:#0e1318;
      color:#ddd;
    }
    .controls{display:grid;gap:10px}
    .control{
      display:grid;
      grid-template-columns:160px 1fr auto;
      gap:10px;
      align-items:center;
    }
    .control input[type=range]{width:100%}
    .hint{color:var(--muted);font-size:12px}
    button{
      appearance:none;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      background:var(--accent);
      color:#001e36;
      transition:transform .04s ease,opacity .2s;
    }
    button.secondary{
      background:#1e2a34;
      color:#cfe6ff;
    }
    button:disabled{opacity:.5;cursor:not-allowed}
    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
      font-size:12px;
    }
    .progress{
      height:10px;
      background:#0c1116;
      border:1px solid #1e2a34;
      border-radius:999px;
      overflow:hidden;
    }
    .progress>span{
      display:block;
      height:100%;
      width:0;
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      transition:width .2s;
    }
    canvas{
      display:block;
      width:100%;
      height:140px;
      background:#0c1116;
      border:1px solid #1e2a34;
      border-radius:10px;
      cursor:crosshair;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border:1px solid #34485a;
      border-radius:999px;
      font-size:12px;
      color:#c7d7e5;
      background:#0e151b;
    }
    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      background:#0e141a;
      border:1px solid #1e2a34;
      border-radius:999px;
    }
    .footer{color:#8aa0b2;font-size:12px;padding:14px}
    .seglist{
      max-height:180px;
      overflow:auto;
      border:1px solid #1e2a34;
      border-radius:10px;
      padding:8px;
      background:#0e1318;
    }
    .seglist div{
      padding:4px 6px;
      border-bottom:1px dashed #1e2a34;
    }
    .seglist div:last-child{border-bottom:none}
    .error{color:var(--err)}
    .ok{color:var(--accent-2)}
    select,input[type="text"]{
      background:#0e1318;
      color:#eaf2f9;
      border:1px solid #1e2a34;
      border-radius:10px;
      padding:8px;
    }
    @media (max-width:960px){
      .grid{grid-template-columns:1fr}
    }
  </style>

  <!-- ffmpeg.wasm UMD (åŒä¸€ãƒªãƒã‚¸ãƒˆãƒªã® assets/ffmpeg/ ã«é…ç½®) -->
  <script src="assets/ffmpeg/ffmpeg.min.js"></script>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between">
      <h1>ğŸ¬ ç„¡éŸ³ã‚«ãƒƒãƒˆè‡ªå‹•åŒ–ï¼ˆGitHub Pages / ffmpeg.wasmï¼‰</h1>
      <div class="pill">
        <span class="badge">Free</span>
        <span class="badge">Client-side</span>
        <span class="badge">Safari / Chrome</span>
      </div>
    </div>
  </header>

  <div class="container grid">
    <section class="card">
      <h2>â‘  å‹•ç”»ã‚’é¸æŠ & è§£æ / ãƒ©ã‚¤ãƒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
      <div class="body">
        <div class="row" style="justify-content:space-between">
          <div>
            <label for="file">å…¥åŠ›å‹•ç”»ï¼ˆPC / iPadï¼‰</label><br>
            <input type="file" id="file" accept="video/*" />
            <div class="hint">å¤§ããªå‹•ç”»ã¯ç«¯æœ«ãƒ¡ãƒ¢ãƒªã‚’å¤šãæ¶ˆè²»ã—ã¾ã™ï¼ˆæ¨å¥¨: 20åˆ†ãƒ»1GBä»¥ä¸‹ï¼‰ã€‚</div>
          </div>
          <div>
            <button id="analyzeBtn" class="secondary" disabled>éŸ³é‡ã‚’è§£æã™ã‚‹</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <canvas id="wave" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚·ãƒ¼ã‚¯"></canvas>
          <div class="hint">
            æ³¢å½¢ã¯ <span class="mono">dBFS</span>ï¼ˆ0=æœ€å¤§ã€è² ã®å€¤=å°ã•ã„ï¼‰ã€‚<b>é’ç·š=ã—ãã„å€¤</b>ã€<b>ç·‘å¸¯=ä¿æŒåŒºé–“</b>ã€‚
          </div>
        </div>

        <div class="controls" style="margin-top:12px">
          <div class="control">
            <label>ã—ãã„å€¤ï¼ˆdBFSï¼‰</label>
            <input type="range" id="thresh" min="-90" max="0" step="1" value="-40" />
            <span id="threshVal" class="mono">-40 dB</span>
          </div>
          <div class="control">
            <label>æœ€å°ç„¡éŸ³é•·ï¼ˆmsï¼‰</label>
            <input type="range" id="minSil" min="50" max="4000" step="50" value="300" />
            <span id="minSilVal" class="mono">300 ms</span>
          </div>
          <div class="control">
            <label>å‰å¾Œãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆmsï¼‰</label>
            <input type="range" id="pad" min="0" max="1000" step="50" value="120" />
            <span id="padVal" class="mono">120 ms</span>
          </div>
          <div class="control">
            <label>è§£æçª“å¹…ï¼ˆmsï¼‰</label>
            <input type="range" id="win" min="10" max="200" step="10" value="40" />
            <span id="winVal" class="mono">40 ms</span>
          </div>
          <div class="control">
            <label>ãƒ©ã‚¤ãƒ–å†è§£æ</label>
            <label class="row" style="gap:8px">
              <input type="checkbox" id="live" checked> ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œã§å³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
            </label>
            <span class="hint">è² è·ãŒé«˜ã„å ´åˆã¯OFFã«ã—ã¦ãã ã•ã„</span>
          </div>
        </div>

        <div class="row" style="margin-top:8px;justify-content:space-between;align-items:center">
          <label class="row" style="gap:8px">
            <input type="checkbox" id="previewToggle" disabled> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç„¡éŸ³ã‚’ã‚¹ã‚­ãƒƒãƒ—
          </label>
          <div class="row" style="gap:8px">
            <button id="previewStart" class="secondary" disabled>â–¶ å†ç”Ÿ</button>
            <button id="previewStop" class="secondary" disabled>â¸ åœæ­¢</button>
          </div>
        </div>

        <video id="player" controls playsinline preload="metadata" muted></video>
        <div class="hint">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯<b>å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã›ãš</b>ã«ä¿æŒåŒºé–“ã ã‘é€£ç¶šå†ç”Ÿã—ã¾ã™ã€‚</div>

        <div style="margin-top:8px" class="row">
          <button id="recalcBtn" class="secondary" disabled>æ‰‹å‹•ã§å†è¨ˆç®—</button>
          <span id="analysisMeta" class="hint"></span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>â‘¡ æ›¸ãå‡ºã—æ–¹å¼ & è¨­å®š</h2>
      <div class="body">
        <div class="row" style="gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap">
          <div>
            <label>æ›¸ãå‡ºã—æ–¹å¼</label><br>
            <select id="exportMode">
              <option value="fast">é«˜é€Ÿï¼ˆffmpegå†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰</option>
              <option value="realtime">å®Ÿæ™‚é–“ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãã®ã¾ã¾éŒ²ç”»ï¼‰</option>
            </select>
            <div class="hint">é«˜é€Ÿ=å¾…ã¡æ™‚é–“çŸ­ã„ / å®Ÿæ™‚é–“=ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã¨å®Œå…¨ä¸€è‡´</div>
          </div>
          <div>
            <label>å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å</label><br>
            <input id="outNameInput" type="text" value="cut_output.mp4" style="width:220px" />
          </div>
          <div>
            <label>ç”»è³ªï¼ˆCRFï¼‰</label><br>
            <input type="range" id="crf" min="18" max="30" step="1" value="22" style="width:220px" />
            <span id="crfVal" class="mono">CRF 22</span>
            <div class="hint">å°ã•ã„ã»ã©é«˜ç”»è³ªãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å¤§</div>
          </div>
          <div>
            <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label><br>
            <select id="preset">
              <option value="veryfast" selected>veryfast</option>
              <option value="faster">faster</option>
              <option value="fast">fast</option>
              <option value="medium">medium</option>
            </select>
          </div>
          <div>
            <label>éŸ³å£°ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ</label><br>
            <select id="abitrate">
              <option value="128k">128k</option>
              <option value="160k">160k</option>
              <option value="192k" selected>192k</option>
              <option value="256k">256k</option>
            </select>
          </div>
          <div>
            <button id="cutBtn" disabled>ç„¡éŸ³ã‚’ã‚«ãƒƒãƒˆã—ã¦æ›¸ãå‡ºã—</button>
          </div>
        </div>

        <div style="margin:10px 0" class="progress"><span id="prog"></span></div>
        <div id="log" class="mono hint" style="white-space:pre-wrap;max-height:180px;overflow:auto"></div>

        <h3 style="margin:12px 0 6px">ä¿æŒåŒºé–“ï¼ˆéŸ³ãŒã‚ã‚‹ã¨åˆ¤æ–­ï¼‰</h3>
        <div id="segList" class="seglist hint">è§£æå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™â€¦</div>

        <div id="outWrap" style="margin-top:12px"></div>
        <div class="footer">â€» ã™ã¹ã¦ç«¯æœ«å†…ã§å‡¦ç†ã—ã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯è¡Œã„ã¾ã›ã‚“ã€‚</div>
      </div>
    </section>
  </div>

  <div class="container" style="margin-top:-6px">
    <section class="card">
      <h2>è£œè¶³ï¼ˆå®Ÿè£…ã®è¦ç‚¹ & ç’°å¢ƒè¨ºæ–­ï¼‰</h2>
      <div class="body">
        <ul>
          <li>Web Audio API ã§çŸ­æ™‚é–“RMS â†’ dBFSåŒ–ã—ã€<strong>ã—ãã„å€¤</strong>ãƒ»<strong>ç„¡éŸ³é•·</strong>ãƒ»<strong>å‰å¾Œãƒ‘ãƒ‡ã‚£ãƒ³ã‚°</strong>ã§ä¿æŒåŒºé–“ã‚’æŠ½å‡ºã—ã¾ã™ã€‚</li>
          <li>æ›¸ãå‡ºã—ã¯ã€Œé«˜é€Ÿ: ffmpeg å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã€ã¾ãŸã¯ã€Œå®Ÿæ™‚é–“: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éŒ²ç”»ã€ã‹ã‚‰é¸æŠã§ãã¾ã™ã€‚</li>
          <li>ffmpeg ã§ã‚¨ãƒ©ãƒ¼ãƒ»æ¥µç«¯ã«å°ã•ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºãŸå ´åˆã¯ã€è‡ªå‹•ã§å®Ÿæ™‚é–“éŒ²ç”»ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚</li>
        </ul>
        <button id="diagBtn" class="secondary">ç’°å¢ƒè¨ºæ–­ã‚’å®Ÿè¡Œ</button>
      </div>
    </section>
  </div>

  <script>
    (function(){
      'use strict';

      // --- è¦ç´ å‚ç…§ ---
      const els = {
        file: document.getElementById('file'),
        analyze: document.getElementById('analyzeBtn'),
        recalc: document.getElementById('recalcBtn'),
        cut: document.getElementById('cutBtn'),
        wave: document.getElementById('wave'),
        segList: document.getElementById('segList'),
        thresh: document.getElementById('thresh'),
        threshVal: document.getElementById('threshVal'),
        minSil: document.getElementById('minSil'),
        minSilVal: document.getElementById('minSilVal'),
        pad: document.getElementById('pad'),
        padVal: document.getElementById('padVal'),
        win: document.getElementById('win'),
        winVal: document.getElementById('winVal'),
        live: document.getElementById('live'),
        analysisMeta: document.getElementById('analysisMeta'),
        log: document.getElementById('log'),
        prog: document.getElementById('prog'),
        outWrap: document.getElementById('outWrap'),
        player: document.getElementById('player'),
        previewToggle: document.getElementById('previewToggle'),
        previewStart: document.getElementById('previewStart'),
        previewStop: document.getElementById('previewStop'),
        outNameInput: document.getElementById('outNameInput'),
        crf: document.getElementById('crf'),
        crfVal: document.getElementById('crfVal'),
        preset: document.getElementById('preset'),
        abitrate: document.getElementById('abitrate'),
        exportMode: document.getElementById('exportMode'),
        diagBtn: document.getElementById('diagBtn'),
      };

      function log(msg){
        els.log.textContent += '\n' + msg;
        els.log.scrollTop = els.log.scrollHeight;
      }
      function error(msg){ log('âŒ ' + msg); }

      // --- çŠ¶æ…‹ ---
      let decoded = null;          // {audioBuffer, duration}
      let analysis = null;         // {dbfs, stepSec, duration}
      let keepSegments = [];       // [{start,end}, ...]
      let inputBlobURL = null;
      let previewOn = false;

      let ffmpeg = null;
      let ffmpegReady = false;

      function ensureCutState(){
        els.cut.disabled = !(decoded && analysis && keepSegments.length > 0);
      }

      // --- ãƒ©ãƒ™ãƒ«è¡¨ç¤ºåŒæœŸ ---
      function syncLabels(){
        els.threshVal.textContent = els.thresh.value + ' dB';
        els.minSilVal.textContent = els.minSil.value + ' ms';
        els.padVal.textContent    = els.pad.value    + ' ms';
        els.winVal.textContent    = els.win.value    + ' ms';
        els.crfVal.textContent    = 'CRF ' + els.crf.value;
      }
      ['thresh','minSil','pad','win','crf'].forEach(id=>{
        els[id].addEventListener('input',()=>{
          syncLabels();
          if(els.live.checked && decoded){
            debouncedRecompute();
          }else{
            if(analysis) drawWave(analysis.dbfs);
          }
        });
      });
      syncLabels();

      // --- ffmpeg åˆæœŸåŒ–ï¼ˆå˜ç´”ç‰ˆï¼‰ ---
      async function ensureFFmpeg(){
        if(ffmpegReady) return;
        if(!window.FFmpeg || !FFmpeg.createFFmpeg || !FFmpeg.fetchFile){
          throw new Error('FFmpeg UMD ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚assets/ffmpeg/ffmpeg.min.js ã®é…ç½®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        const { createFFmpeg } = FFmpeg;
        const corePath = 'assets/ffmpeg/ffmpeg-core.js';

        ffmpeg = createFFmpeg({
          corePath,
          log: true,
        });

        ffmpeg.setLogger?.(({type,message})=>{
          els.log.textContent += `\n[ffmpeg:${type}] ${message}`;
          els.log.scrollTop = els.log.scrollHeight;
        });
        ffmpeg.setProgress?.(({ratio})=>{
          const r = Number.isFinite(ratio) ? Math.min(1, Math.max(0, ratio)) : 0;
          els.prog.style.width = (r*100).toFixed(1) + '%';
        });

        log('ffmpeg.wasm èµ·å‹•ä¸­â€¦');
        await ffmpeg.load();
        ffmpegReady = true;
        log('ffmpeg.wasm æº–å‚™å®Œäº†');
      }

      // --- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ ---
      els.file.addEventListener('change',()=>{
        const f = els.file.files?.[0];
        if(!f){
          els.analyze.disabled = true;
          ensureCutState();
          return;
        }
        els.analyze.disabled = false;
        els.recalc.disabled  = true;

        decoded = null;
        analysis = null;
        keepSegments = [];

        drawWave([]);
        els.segList.textContent = 'è§£æå¾…ã¡â€¦';
        els.outWrap.innerHTML = '';
        els.analysisMeta.textContent = '';

        if(inputBlobURL) URL.revokeObjectURL(inputBlobURL);
        inputBlobURL = URL.createObjectURL(f);
        els.player.src = inputBlobURL;
        els.player.load();
        els.previewStart.disabled = false;
        els.previewStop.disabled  = false;
        els.previewToggle.disabled = true;

        log(`é¸æŠ: ${f.name} (${(f.size/1e6).toFixed(1)} MB)`);
      });

      els.player.addEventListener('loadedmetadata', ()=>{
        log(`ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—: duration=${(els.player.duration||0).toFixed(2)}s`);
      });

      // --- éŸ³å£°è§£æ ---
      els.analyze.addEventListener('click', async()=>{
        const file = els.file.files?.[0];
        if(!file) return;

        els.analyze.disabled = true;
        log('éŸ³å£°ãƒ‡ã‚³ãƒ¼ãƒ‰ä¸­â€¦');

        try{
          const AC = window.AudioContext || window.webkitAudioContext;
          if(!AC) throw new Error('AudioContext ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ãŠè©¦ã—ãã ã•ã„ã€‚');

          const ctx = new AC();
          const buf = await ctx.decodeAudioData(await file.arrayBuffer());
          decoded = {audioBuffer: buf, duration: buf.duration};
          log(`Audio decoded: ${buf.duration.toFixed(3)} sec, ch=${buf.numberOfChannels}, sr=${buf.sampleRate}`);
          ctx.close?.();

          await computeAnalysis();

          els.recalc.disabled = false;
          els.previewToggle.disabled = false;
          els.previewStart.disabled = false;
          els.previewStop.disabled  = false;
        }catch(e){
          error(`ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—: ${e?.message || e}`);
          els.analyze.disabled = false;
        }finally{
          ensureCutState();
        }
      });

      els.recalc.addEventListener('click', async()=>{
        if(!decoded) return;
        await computeAnalysis();
      });

      let recomputeTimer = null;
      function debouncedRecompute(){
        clearTimeout(recomputeTimer);
        recomputeTimer = setTimeout(()=>{ computeAnalysis(); }, 160);
      }

      async function computeAnalysis(){
        if(!decoded){
          ensureCutState();
          return;
        }
        try{
          const {audioBuffer, duration} = decoded;
          const sr = audioBuffer.sampleRate;
          const ch = audioBuffer.numberOfChannels;

          const winMs = +els.win.value;
          const stepSamples = Math.max(1, Math.round((winMs/1000)*sr));
          const len = Math.ceil(audioBuffer.length / stepSamples);
          const dbfs = new Float32Array(len);
          const eps = 1e-12;

          const chData = Array.from({length: ch}, (_,i)=>audioBuffer.getChannelData(i));

          let idx = 0;
          for(let s=0; s<audioBuffer.length; s+=stepSamples){
            const end = Math.min(s+stepSamples, audioBuffer.length);
            let sumsq = 0;
            let count = 0;
            for(let i=s; i<end; i++){
              let sample = 0;
              for(let c=0; c<ch; c++) sample += chData[c][i] || 0;
              sample /= ch;
              sumsq += sample*sample;
              count++;
            }
            const rms = Math.sqrt(sumsq / Math.max(1, count));
            const d = 20*Math.log10(Math.max(rms, eps));
            dbfs[idx++] = d;
          }

          analysis = {dbfs, stepSec: stepSamples/sr, duration};

          const thr    = +els.thresh.value;
          const minSil = +els.minSil.value / 1000;
          const pad    = +els.pad.value    / 1000;

          keepSegments = buildKeepSegments(dbfs, analysis.stepSec, duration, thr, minSil, pad);

          els.analysisMeta.textContent =
            `æ¤œå‡ºã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: ${winMs}ms, ã‚µãƒ³ãƒ—ãƒ«æ•°: ${dbfs.length}, æ®‹ã™åŒºé–“: ${keepSegments.length} å€‹`;

          drawWave(dbfs);
          renderSegments();
          ensureCutState();

          if(keepSegments.length > 0){
            els.cut.disabled = false;
          }
        }catch(e){
          error(`è§£æã‚¨ãƒ©ãƒ¼: ${e?.message || e}`);
        }finally{
          ensureCutState();
        }
      }

      function buildKeepSegments(dbfs, step, duration, thr, minSil, pad){
        const mask = dbfs.map(v => v >= thr ? 1 : 0);
        const raw = [];
        let runStart = null;

        for(let i=0; i<mask.length; i++){
          if(mask[i] === 1 && runStart === null){
            runStart = i;
          }
          if((mask[i] === 0 || i === mask.length-1) && runStart !== null){
            const last = (mask[i] === 0 ? i-1 : i);
            const st = runStart * step;
            const en = Math.min((last+1)*step, duration);
            raw.push({start: st, end: en});
            runStart = null;
          }
        }

        // ç„¡éŸ³ã‚®ãƒ£ãƒƒãƒ—ãŒçŸ­ã„ã‚‚ã®ã¯ãƒãƒ¼ã‚¸
        const merged = [];
        for(const s of raw){
          const prev = merged[merged.length-1];
          if(prev && s.start - prev.end < minSil){
            prev.end = s.end;
          }else{
            merged.push({...s});
          }
        }

        return merged.map(s=>({
          start: Math.max(0, s.start - pad),
          end:   Math.min(duration, s.end + pad),
        }));
      }

      // --- æ³¢å½¢æç”» ---
      function drawWave(dbfs){
        const canvas = els.wave;
        const dpr = window.devicePixelRatio || 1;
        const W = canvas.clientWidth  || canvas.offsetWidth  || 600;
        const H = canvas.clientHeight || canvas.offsetHeight || 140;

        canvas.width  = Math.floor(W*dpr);
        canvas.height = Math.floor(H*dpr);

        const ctx = canvas.getContext('2d');
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,W,H);

        // ã‚¬ã‚¤ãƒ‰ç·š
        ctx.strokeStyle = '#1f2a35';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let y=0; y<=4; y++){
          const yy = (H-20)*(y/4) + 10;
          ctx.moveTo(8, yy);
          ctx.lineTo(W-8, yy);
        }
        ctx.stroke();

        const toY = v=>{
          const clamped = Math.max(-90, Math.min(0, v || -90));
          const t = (clamped + 90) / 90; // 0..1
          return 10 + (1 - t) * (H-20);
        };
        const tToX = t=>{
          const dur = analysis?.duration || 1;
          return 10 + (t / dur) * (W-20);
        };

        // ä¿æŒåŒºé–“ï¼ˆç·‘å¸¯ï¼‰
        if(analysis && keepSegments.length){
          ctx.fillStyle = 'rgba(108,225,166,0.18)';
          keepSegments.forEach(s=>{
            const x1 = tToX(s.start);
            const x2 = tToX(s.end);
            ctx.fillRect(x1, 10, Math.max(1, x2 - x1), H-20);
          });
        }

        // æ³¢å½¢
        if(dbfs && dbfs.length){
          ctx.strokeStyle = '#6ce1a6';
          ctx.lineWidth = 1;
          ctx.beginPath();
          for(let i=0; i<dbfs.length; i++){
            const x = 10 + (i / Math.max(1, dbfs.length-1))*(W-20);
            const y = toY(dbfs[i]);
            if(i === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          }
          ctx.stroke();
        }

        // ã—ãã„å€¤ãƒ©ã‚¤ãƒ³
        const thr = +els.thresh.value;
        const ythr = toY(thr);
        ctx.strokeStyle = '#4aa3ff';
        ctx.setLineDash([4,4]);
        ctx.beginPath();
        ctx.moveTo(8, ythr);
        ctx.lineTo(W-8, ythr);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      function renderSegments(){
        if(!keepSegments.length){
          els.segList.innerHTML = '<div>æ¤œå‡ºã•ã‚ŒãŸä¿æŒåŒºé–“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã—ãã„å€¤ã‚’ä¸‹ã’ã‚‹ / ç„¡éŸ³é•·ã‚’çŸ­ãã™ã‚‹ãªã©èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</div>';
          return;
        }
        const fmt = t => new Date(t*1000).toISOString().substring(11, 23);
        els.segList.innerHTML = keepSegments.map((s,i)=>(
          `<div>#${i+1} <span class="mono">${fmt(s.start)}</span> â†’ <span class="mono">${fmt(s.end)}</span> <span class="hint">(${(s.end-s.start).toFixed(2)}s)</span></div>`
        )).join('');
      }

      // --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç„¡éŸ³ã‚¹ã‚­ãƒƒãƒ—ï¼‰ ---
      function withinKeep(t){
        for(const seg of keepSegments){
          if(t >= seg.start && t < seg.end) return seg;
        }
        return null;
      }
      function nextKeepStartAfter(t){
        for(const seg of keepSegments){
          if(seg.end <= t) continue;
          if(t < seg.start) return seg.start;
        }
        return null;
      }

      els.previewToggle.addEventListener('change',()=>{
        previewOn = !!els.previewToggle.checked;
        if(previewOn && keepSegments.length){
          els.player.currentTime = keepSegments[0].start;
        }
      });

      els.previewStart.addEventListener('click', ()=>{
        if(keepSegments.length && previewOn){
          els.player.currentTime = keepSegments[0].start;
        }
        els.player.play();
      });

      els.previewStop.addEventListener('click', ()=>{
        els.player.pause();
      });

      els.player.addEventListener('timeupdate', ()=>{
        if(!previewOn || !keepSegments.length) return;
        const t = els.player.currentTime;
        const seg = withinKeep(t);
        if(!seg){
          const nextStart = nextKeepStartAfter(t);
          if(nextStart != null){
            els.player.currentTime = nextStart;
          }else{
            els.player.pause();
          }
        }
      });

      els.wave.addEventListener('click', e=>{
        if(!analysis) return;
        const rect = els.wave.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const t = x * analysis.duration;
        if(previewOn){
          const seg = withinKeep(t);
          if(!seg){
            const nxt = nextKeepStartAfter(t);
            if(nxt != null){
              els.player.currentTime = nxt;
            }else{
              els.player.pause();
            }
            return;
          }
        }
        els.player.currentTime = t;
      });

      // --- å®Ÿæ™‚é–“ãƒ¢ãƒ¼ãƒ‰ç”¨: ä¿æŒåŒºé–“ã‚’é †ç•ªã«å†ç”Ÿ ---
      async function playSegmentsWithSkip(player, segments){
        if(!segments.length) return;
        let idx = 0;
        let ended = false;
        const dur = player.duration || (analysis?.duration ?? 0);

        return new Promise(resolve=>{
          let rafId = 0;
          function jumpTo(i){
            if(i >= segments.length){
              stop();
              return;
            }
            const s = segments[i];
            player.currentTime = Math.min(Math.max(0, s.start), dur || (s.start+0.001));
            player.play().catch(()=>{});
          }
          function stop(){
            if(ended) return;
            ended = true;
            cancelAnimationFrame(rafId);
            player.pause();
            resolve();
          }
          function tick(){
            if(ended) return;
            const t = player.currentTime;
            const seg = segments[idx];
            if(!(t >= seg.start && t < seg.end)){
              if(t < seg.start){
                player.currentTime = seg.start;
              }else{
                idx++;
                if(idx >= segments.length){
                  stop();
                  return;
                }
                player.currentTime = segments[idx].start;
              }
            }else{
              if(t >= seg.end){
                idx++;
                if(idx >= segments.length){
                  stop();
                  return;
                }
                player.currentTime = segments[idx].start;
              }
            }
            rafId = requestAnimationFrame(tick);
          }
          jumpTo(0);
          rafId = requestAnimationFrame(tick);
        });
      }

      // --- MediaRecorder éŒ²ç”» â†’ MP4 åŒ– ---
      async function recordPreviewToMP4(player, segments, preferredName){
        const prevMuted = player.muted;
        const prevVolume = player.volume;

        player.muted = false;
        player.volume = 0;

        const stream = player.captureStream ? player.captureStream() :
                       player.mozCaptureStream ? player.mozCaptureStream() :
                       null;
        if(!stream) throw new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ captureStream() ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');

        const mp4Mime  = 'video/mp4;codecs="avc1.42E01E,mp4a.40.2"';
        const webmVp9  = 'video/webm;codecs="vp9,opus"';
        const webmVp8  = 'video/webm;codecs="vp8,opus"';

        let mimeType = '';
        if('MediaRecorder' in window && MediaRecorder.isTypeSupported(mp4Mime)){
          mimeType = mp4Mime;
        }else if('MediaRecorder' in window && MediaRecorder.isTypeSupported(webmVp9)){
          mimeType = webmVp9;
        }else if('MediaRecorder' in window && MediaRecorder.isTypeSupported(webmVp8)){
          mimeType = webmVp8;
        }else{
          throw new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ MediaRecorder éŒ²ç”»ï¼ˆmp4/webmï¼‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        }

        const chunks = [];
        const rec = new MediaRecorder(stream, {mimeType});
        rec.ondataavailable = e=>{
          if(e.data && e.data.size > 0) chunks.push(e.data);
        };

        const started = new Promise(res => rec.onstart = res);
        const stopped = new Promise(res => rec.onstop  = res);

        rec.start(250);
        await started;
        await playSegmentsWithSkip(player, segments);
        await new Promise(r => setTimeout(r, 120));
        rec.requestData?.();
        rec.stop();
        await stopped;

        player.muted = prevMuted;
        player.volume = prevVolume;

        const recordedBlob = new Blob(chunks, {type: rec.mimeType});
        const name = ensureMp4Name(preferredName);

        if(rec.mimeType.startsWith('video/mp4')){
          return { blob: recordedBlob, name };
        }

        // webm â†’ mp4 ã«å¤‰æ›
        await ensureFFmpeg();
        const inputBytes = new Uint8Array(await recordedBlob.arrayBuffer());
        const inWbm = 'rec_in.webm';
        const outMp = 'rec_out.mp4';

        ffmpeg.FS('writeFile', inWbm, inputBytes);
        await ffmpeg.run(
          '-y', '-i', inWbm,
          '-c:v','libx264','-pix_fmt','yuv420p','-preset','veryfast','-crf','22',
          '-c:a','aac','-b:a','192k',
          '-movflags','+faststart',
          outMp
        );
        const mp4Data = ffmpeg.FS('readFile', outMp);
        return { blob: new Blob([mp4Data], {type:'video/mp4'}), name };
      }

      function ensureMp4Name(base){
        let name = (base || els.outNameInput.value || 'cut_output.mp4').trim();
        if(!/\.mp4$/i.test(name)) name += '.mp4';
        return name;
      }

      async function saveBlobWithPickerOrDownload(blob, name){
        try{
          if('showSaveFilePicker' in window){
            const handle = await window.showSaveFilePicker({
              suggestedName: name,
              types:[{description:'MP4 Video', accept:{'video/mp4':['.mp4']}}]
            });
            const stream = await handle.createWritable();
            await stream.write(blob);
            await stream.close();
            log(`ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ: ${handle.name}`);
            showInlinePreview(blob, name);
            return;
          }
        }catch(e){
          error('ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸã€‚è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
        }
        // é€šå¸¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();

        showInlinePreview(blob, name, url);
      }

      function showInlinePreview(blob, name, reuseUrl){
        const url = reuseUrl || URL.createObjectURL(blob);
        const sizeMB = (blob.size/1e6).toFixed(1);
        els.outWrap.innerHTML = `
          <div class="ok">âœ… æ›¸ãå‡ºã—å®Œäº†: ${sizeMB} MB</div>
          <video controls style="width:100%;max-height:360px;margin-top:8px;border:1px solid #1e2a34;border-radius:10px" src="${url}"></video>
          <div style="margin-top:8px">
            <a download="${name}" href="${url}"><button>ã‚‚ã†ä¸€åº¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button></a>
            <button class="secondary" id="resetBtn">åˆ¥ã®å‹•ç”»ã§ã‚„ã‚Šç›´ã™</button>
          </div>
        `;
        document.getElementById('resetBtn')?.addEventListener('click',()=>location.reload());
      }

      // --- ffmpeg ã§é«˜é€Ÿæ›¸ãå‡ºã— ---
      function fsReadSizeSafe(path){
        try{
          const u8 = ffmpeg.FS('readFile', path);
          return u8 ? u8.length : 0;
        }catch{
          return 0;
        }
      }

      async function exportViaFFmpeg(file){
        await ensureFFmpeg();
        const MIN_BYTES = 2*1024; // 2KB æœªæº€ã¯å¤±æ•—æ‰±ã„

        const { fetchFile } = FFmpeg;
        const inputData = await fetchFile(file);
        ffmpeg.FS('writeFile', 'input.mp4', inputData);

        const outName = 'out.mp4';
        const preset  = els.preset.value;
        const crf     = String(els.crf.value);
        const abr     = els.abitrate.value;

        // æ˜ åƒ + éŸ³å£° åŒæ™‚ concat
        const chains = [];
        const maps   = [];
        keepSegments.forEach((s,i)=>{
          const st = s.start.toFixed(3);
          const en = s.end.toFixed(3);
          chains.push(`[0:v]trim=start=${st}:end=${en},setpts=PTS-STARTPTS[v${i}]`);
          chains.push(`[0:a]atrim=start=${st}:end=${en},asetpts=PTS-STARTPTS[a${i}]`);
          maps.push(`[v${i}][a${i}]`);
        });
        const filterAV = `${chains.join(';')};${maps.join('')}concat=n=${keepSegments.length}:v=1:a=1[v][a]`;

        let ok = false;
        log('ffmpeg: æ˜ åƒ+éŸ³å£° concat å®Ÿè¡Œ');
        try{
          await ffmpeg.run(
            '-y',
            '-i','input.mp4',
            '-filter_complex', filterAV,
            '-map','[v]','-map','[a]',
            '-c:v','libx264','-pix_fmt','yuv420p','-preset', preset,'-crf', crf,
            '-c:a','aac','-b:a', abr,
            '-movflags','+faststart',
            outName
          );
          const bytes = fsReadSizeSafe(outName);
          if(bytes > MIN_BYTES){
            ok = true;
          }else{
            log(`å‡ºåŠ›ãŒå°ã•ã™ãã¾ã™ï¼ˆ${bytes} bytesï¼‰â†’ æ˜ åƒã®ã¿ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è©¦è¡Œ`);
          }
        }catch(e){
          log('ä¸€æ¬¡å¤‰æ›ä¾‹å¤– â†’ æ˜ åƒã®ã¿ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è©¦è¡Œ: ' + (e?.message || e));
        }

        if(!ok){
          // æ˜ åƒã®ã¿
          try{
            const chainsV = keepSegments.map((s,i)=>
              `[0:v]trim=start=${s.start.toFixed(3)}:end=${s.end.toFixed(3)},setpts=PTS-STARTPTS[v${i}]`
            ).join(';');
            const catV = keepSegments.map((_,i)=>`[v${i}]`).join('');
            const filterV = `${chainsV};${catV}concat=n=${keepSegments.length}:v=1:a=0[v]`;

            await ffmpeg.run(
              '-y',
              '-i','input.mp4',
              '-filter_complex', filterV,
              '-map','[v]',
              '-c:v','libx264','-pix_fmt','yuv420p','-preset', preset,'-crf', crf,
              '-movflags','+faststart',
              outName
            );
            const bytes2 = fsReadSizeSafe(outName);
            if(bytes2 <= MIN_BYTES){
              throw new Error(`ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã‚‚æ¥µç«¯ã«å°ã•ã„å‡ºåŠ›ï¼ˆ${bytes2} bytesï¼‰`);
            }
          }catch(e2){
            throw new Error('[ffmpeg] å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å®Ÿæ™‚é–“ãƒ¢ãƒ¼ãƒ‰ã¸è‡ªå‹•åˆ‡æ›¿ã—ã¾ã™ã€‚ç†ç”±: ' + (e2?.message || e2));
          }
        }

        const data = ffmpeg.FS('readFile', outName);
        return new Blob([data], {type:'video/mp4'});
      }

      // --- ãƒ¡ã‚¤ãƒ³ã€Œæ›¸ãå‡ºã—ã€ãƒœã‚¿ãƒ³ ---
      els.cut.addEventListener('click', async()=>{
        if(!Array.isArray(keepSegments) || keepSegments.length === 0){
          error('ä¿æŒåŒºé–“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã—ãã„å€¤â†“ / æœ€å°ç„¡éŸ³é•·â†“ ã§å†è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚');
          els.segList.scrollIntoView({behavior:'smooth'});
          return;
        }
        const file = els.file.files?.[0];
        if(!file){
          error('å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‹•ç”»ã‚’é¸æŠâ†’è§£æã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        els.cut.disabled    = true;
        els.recalc.disabled = true;
        els.analyze.disabled = true;
        els.prog.style.width = '0%';

        const mode = els.exportMode?.value || 'fast';
        let finalBlob = null;
        let finalName = ensureMp4Name(els.outNameInput.value || 'cut_output.mp4');

        try{
          if(mode === 'fast'){
            log('æ›¸ãå‡ºã—é–‹å§‹ï¼ˆé«˜é€Ÿ: ffmpegå†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰â€¦');
            try{
              const blob = await exportViaFFmpeg(file);
              if(!blob || blob.size < 2000){
                throw new Error(`å‡ºåŠ›ãŒå°ã•ã™ãã¾ã™ï¼ˆ${blob?.size || 0} bytesï¼‰`);
              }
              finalBlob = blob;
            }catch(fferr){
              error(String(fferr));
              log('â†’ å®‰å…¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå®Ÿæ™‚é–“: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éŒ²ç”»ï¼‰ã«åˆ‡æ›¿ã—ã¾ã™');
              const rec = await recordPreviewToMP4(els.player, keepSegments, finalName);
              if(!rec.blob || rec.blob.size < 2000){
                throw new Error(`éŒ²ç”»çµæœãŒå°ã•ã™ãã¾ã™ï¼ˆ${rec.blob?.size || 0} bytesï¼‰`);
              }
              finalBlob = rec.blob;
              finalName = rec.name;
            }
          }else{
            log('æ›¸ãå‡ºã—é–‹å§‹ï¼ˆå®Ÿæ™‚é–“: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éŒ²ç”»ï¼‰â€¦');
            const rec = await recordPreviewToMP4(els.player, keepSegments, finalName);
            if(!rec.blob || rec.blob.size < 2000){
              throw new Error(`éŒ²ç”»çµæœãŒå°ã•ã™ãã¾ã™ï¼ˆ${rec.blob?.size || 0} bytesï¼‰`);
            }
            finalBlob = rec.blob;
            finalName = rec.name;
          }

          await saveBlobWithPickerOrDownload(finalBlob, finalName);
          log('å®Œäº†');
        }catch(e){
          error(e?.message || e);
        }finally{
          els.recalc.disabled = false;
          els.analyze.disabled = false;
          els.cut.disabled = false;
        }
      });

      // --- ç’°å¢ƒè¨ºæ–­ ---
      els.diagBtn.addEventListener('click', async()=>{
        log('[è¨ºæ–­] é–‹å§‹');
        try{
          const v = document.createElement('video');
          const canPlayMP4 = !!v.canPlayType && !!v.canPlayType('video/mp4');
          log(`[è¨ºæ–­] MP4 å†ç”Ÿå¯: ${canPlayMP4}`);

          if(window.FFmpeg && FFmpeg.createFFmpeg && FFmpeg.fetchFile){
            log('[è¨ºæ–­] FFmpeg UMD ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã§ã™');
          }else{
            throw new Error('FFmpeg UMD ã‚°ãƒ­ãƒ¼ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆassets/ffmpeg/ffmpeg.min.js ã‚’ç¢ºèªï¼‰ã€‚');
          }

          await ensureFFmpeg();
          log('[è¨ºæ–­] ffmpeg.wasm åˆ©ç”¨å¯èƒ½');
          log('[è¨ºæ–­] æˆåŠŸ');
        }catch(e){
          error('[è¨ºæ–­] å¤±æ•—: ' + (e?.message || e));
        }finally{
          ensureCutState();
        }
      });

      // åˆæœŸãƒ­ã‚°
      log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã€‚å‹•ç”»ã‚’é¸æŠã—ã¦ã€ŒéŸ³é‡ã‚’è§£æã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
    })();
  </script>
</body>
</html>
