<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç„¡éŸ³åŒºé–“ã‚ªãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ / ffmpeg.wasmï¼‰</title>
  <style>
    :root{ --bg:#0b0d10;--panel:#12161b;--muted:#8aa0b2;--text:#eaf2f9;--accent:#4aa3ff;--accent-2:#6ce1a6;--warn:#ffb86b;--err:#ff6b6b; }
    *{box-sizing:border-box}body{margin:0;font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans","Noto Sans JP",Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:18px 20px;border-bottom:1px solid #1f2831;background:linear-gradient(180deg,#0d1117,#0a0e13)}
    h1{font-size:18px;margin:0}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    video{width:100%;max-height:320px;background:#0c1116;border:1px solid #1e2a34;border-radius:10px;display:block}
    .card{background:var(--panel);border:1px solid #1e2a34;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,.25)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid #1e2a34;font-size:16px}
    .card .body{padding:14px 16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label{font-weight:600;color:#d5e2ee}
    input[type="file"]{padding:10px;border:1px dashed #2a3a47;border-radius:10px;background:#0e1318;color:#ddd}
    .controls{display:grid;gap:10px}
    .control{display:grid;grid-template-columns:160px 1fr auto;gap:10px;align-items:center}
    .control input[type=range]{width:100%}
    .hint{color:var(--muted);font-size:12px}
    button{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--accent);color:#001e36;transition:transform .04s ease,opacity .2s}
    button.secondary{background:#1e2a34;color:#cfe6ff}
    button:disabled{opacity:.5;cursor:not-allowed}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:12px}
    .progress{height:10px;background:#0c1116;border:1px solid #1e2a34;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .2s}
    canvas{display:block;width:100%;height:140px;background:#0c1116;border:1px solid #1e2a34;border-radius:10px;cursor:crosshair}
    .badge{display:inline-block;padding:2px 8px;border:1px solid #34485a;border-radius:999px;font-size:12px;color:#c7d7e5;background:#0e151b}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;background:#0e141a;border:1px solid #1e2a34;border-radius:999px}
    .footer{color:#8aa0b2;font-size:12px;padding:14px}
    .seglist{max-height:180px;overflow:auto;border:1px solid #1e2a34;border-radius:10px;padding:8px;background:#0e1318}
    .seglist div{padding:4px 6px;border-bottom:1px dashed #1e2a34}
    .seglist div:last-child{border-bottom:none}
    .error{color:var(--err)}
    .ok{color:var(--accent-2)}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between">
      <h1>ğŸ¬ ç„¡éŸ³ã‚«ãƒƒãƒˆè‡ªå‹•åŒ–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã§å®Œçµï¼‰</h1>
      <div class="pill"><span class="badge">Free</span><span class="badge">Client-side</span><span class="badge">Safari/Chrome</span></div>
    </div>
  </header>

  <div class="container grid">
    <section class="card">
      <h2>â‘  å‹•ç”»ã‚’é¸æŠ & è§£æ / ãƒ©ã‚¤ãƒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
      <div class="body">
        <div class="row" style="justify-content:space-between">
          <div>
            <label for="file">å…¥åŠ›å‹•ç”»ï¼ˆiPad/PCã‹ã‚‰ï¼‰</label><br>
            <input type="file" id="file" accept="video/*" />
            <div class="hint">å¤§ããªå‹•ç”»ã¯ç«¯æœ«ãƒ¡ãƒ¢ãƒªã‚’å¤šãæ¶ˆè²»ã—ã¾ã™ï¼ˆæ¨å¥¨: 20åˆ†ãƒ»1GBä»¥ä¸‹ï¼‰ã€‚</div>
          </div>
          <div>
            <button id="analyzeBtn" class="secondary" disabled>éŸ³é‡ã‚’è§£æã™ã‚‹</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <canvas id="wave" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚·ãƒ¼ã‚¯ / ãƒ‰ãƒ©ãƒƒã‚°ã§åŒºé–“ã‚ºãƒ¼ãƒ ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚ºãƒ¼ãƒ è§£é™¤ï¼‰"></canvas>
          <div class="hint">æ³¢å½¢ã¯ <span class="mono">dBFS</span>ï¼ˆ0=æœ€å¤§ã€è² ã®å€¤=å°ã•ã„ï¼‰ã€‚<b>é’ç·š=ã—ãã„å€¤</b>ã€<b>ç·‘å¸¯=ä¿æŒåŒºé–“</b>ã€‚ã‚¯ãƒªãƒƒã‚¯ã§ãã®æ™‚åˆ»ã¸ç§»å‹•ã§ãã¾ã™ã€‚</div>
        </div>

        <div class="controls" style="margin-top:12px">
          <div class="control">
            <label>ã—ãã„å€¤ï¼ˆdBFSï¼‰</label>
            <input type="range" id="thresh" min="-90" max="0" step="1" value="-40" />
            <span id="threshVal" class="mono">-40 dB</span>
          </div>
          <div class="control">
            <label>æœ€å°ç„¡éŸ³é•·ï¼ˆmsï¼‰</label>
            <input type="range" id="minSil" min="50" max="4000" step="50" value="300" />
            <span id="minSilVal" class="mono">300 ms</span>
          </div>
          <div class="control">
            <label>å‰å¾Œãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆmsï¼‰</label>
            <input type="range" id="pad" min="0" max="1000" step="50" value="120" />
            <span id="padVal" class="mono">120 ms</span>
          </div>
          <div class="control">
            <label>è§£æçª“å¹…ï¼ˆmsï¼‰</label>
            <input type="range" id="win" min="10" max="200" step="10" value="40" />
            <span id="winVal" class="mono">40 ms</span>
          </div>
          <div class="control">
            <label>ãƒ©ã‚¤ãƒ–å†è§£æ</label>
            <label class="row" style="gap:8px"><input type="checkbox" id="live" checked> ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œã§å³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°</label>
            <span class="hint">è² è·ãŒé«˜ã„å ´åˆã¯OFFã«ã—ã¦ãã ã•ã„</span>
          </div>
        </div>

        <div class="row" style="margin-top:8px;justify-content:space-between;align-items:center">
          <label class="row" style="gap:8px"><input type="checkbox" id="previewToggle" disabled> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç„¡éŸ³ã‚’ã‚¹ã‚­ãƒƒãƒ—</label>
          <div class="row" style="gap:8px">
            <button id="previewStart" class="secondary" disabled>â–¶ å†ç”Ÿ</button>
            <button id="previewStop" class="secondary" disabled>â¸ åœæ­¢</button>
          </div>
        </div>
        <video id="player" controls playsinline preload="metadata" muted></video>
        <div class="hint">ã‚‚ã—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ããªã„å ´åˆï¼ˆä¾‹: Windows Chrome ã§ iPhone/iPadã®HEVCå‹•ç”»ï¼‰ã¯ã€ä¸‹ã®ã€Œäº’æ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
        <div style="margin-top:6px"><button id="makeProxyBtn" class="secondary" style="display:none">äº’æ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆï¼ˆH.264 ä½è§£åƒåº¦ï¼‰</button> <span id="proxyHint" class="hint"></span></div>
        <div class="hint">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯<b>å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã›ãš</b>ã«ä¿æŒåŒºé–“ã®ã¿ã‚’é€£ç¶šå†ç”Ÿã—ã¾ã™ï¼ˆã‚¹ã‚­ãƒƒãƒ—å†ç”Ÿï¼‰ã€‚</div>

        <div style="margin-top:8px" class="row">
          <button id="recalcBtn" class="secondary" disabled>æ‰‹å‹•ã§å†è¨ˆç®—</button>
          <span id="analysisMeta" class="hint"></span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>â‘¡ è‡ªå‹•ã‚«ãƒƒãƒˆ & æ›¸ãå‡ºã—ï¼ˆffmpeg.wasm ä½¿ç”¨ï¼‰</h2>
      <div class="body">
        <div class="row" style="justify-content:space-between">
          <button id="cutBtn" disabled>ç„¡éŸ³ã‚’ã‚«ãƒƒãƒˆã—ã¦æ›¸ãå‡ºã—</button>
          <div class="row" style="gap:8px">
            <span class="badge">H.264 + AAC</span>
            <span class="badge">å¯å¤‰ãƒ¬ãƒ¼ãƒˆ</span>
          </div>
        </div>

        <div class="row" style="margin-top:10px;gap:14px;align-items:flex-end">
          <div>
            <label>å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å</label><br>
            <input id="outNameInput" type="text" value="cut_output.mp4" style="width:260px;padding:8px;border-radius:10px;border:1px solid #1e2a34;background:#0e1318;color:#eaf2f9" />
            <div class="hint">æ‹¡å¼µå­ã¯ <span class="mono">.mp4</span> æ¨å¥¨</div>
          </div>
          <div>
            <label>ç”»è³ªï¼ˆCRFï¼‰</label><br>
            <input type="range" id="crf" min="18" max="30" step="1" value="22" style="width:220px" />
            <span id="crfVal" class="mono">CRF 22</span>
            <div class="hint">å°ã•ã„ã»ã©é«˜ç”»è³ªãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å¤§</div>
          </div>
          <div>
            <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label><br>
            <select id="preset" style="padding:8px;border-radius:10px;border:1px solid #1e2a34;background:#0e1318;color:#eaf2f9">
              <option value="veryfast" selected>veryfast</option>
              <option value="faster">faster</option>
              <option value="fast">fast</option>
              <option value="medium">medium</option>
            </select>
          </div>
          <div>
            <label>éŸ³å£°ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ</label><br>
            <select id="abitrate" style="padding:8px;border-radius:10px;border:1px solid #1e2a34;background:#0e1318;color:#eaf2f9">
              <option value="128k">128k</option>
              <option value="160k">160k</option>
              <option value="192k" selected>192k</option>
              <option value="256k">256k</option>
            </select>
          </div>
        </div>

        <div style="margin:10px 0" class="progress"><span id="prog"></span></div>
        <div id="log" class="mono hint" style="white-space:pre-wrap;max-height:160px;overflow:auto"></div>

        <h3 style="margin:12px 0 6px">ä¿æŒåŒºé–“ï¼ˆéŸ³ãŒã‚ã‚‹ã¨åˆ¤æ–­ï¼‰</h3>
        <div id="segList" class="seglist hint">è§£æå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™â€¦</div>

        <div id="outWrap" style="margin-top:12px"></div>
        <div class="footer">â€» ã™ã¹ã¦ç«¯æœ«å†…ã§å‡¦ç†ã—ã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯è¡Œã„ã¾ã›ã‚“ã€‚</div>
      </div>
    </section>
  </div>

  <div class="container" style="margin-top:-6px">
    <section class="card">
      <h2>è£œè¶³ï¼ˆå®Ÿè£…ã®è¦ç‚¹ & è¨ºæ–­ï¼‰</h2>
      <div class="body">
        <ul>
          <li>Web Audio API ã§çŸ­æ™‚é–“RMS â†’ dBFSåŒ–ã—ã€<strong>ã—ãã„å€¤</strong>ãƒ»<strong>ç„¡éŸ³é•·</strong>ãƒ»<strong>å‰å¾Œãƒ‘ãƒ‡ã‚£ãƒ³ã‚°</strong>ã§ä¿æŒåŒºé–“ã‚’æŠ½å‡ºã€‚</li>
          <li>æŠ½å‡ºçµæœã‚’ <code>trim/atrim + concat</code> ã® <code>filter_complex</code> ã«å¤‰æ›ã—ã€ffmpeg.wasm ã§å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</li>
          <li>è¨ºæ–­: ä¸‹ã®ãƒœã‚¿ãƒ³ã§ç’°å¢ƒãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€çµæœã¯ãƒ­ã‚°ã«å‡ºã¾ã™ã€‚</li>
        </ul>
        <button id="diagBtn" class="secondary">ç’°å¢ƒè¨ºæ–­ã‚’å®Ÿè¡Œ</button>
      </div>
    </section>
  </div>

  <!-- â˜… ffmpeg UMDï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ï¼‰ãƒ­ãƒ¼ãƒ€ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿/æ‰‹å…¥åŠ›ã§ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹æŒ‡å®šå¯ -->
  <script>
    // URL ?ffbase=/path/to/ffmpeg/ ã‚’å„ªå…ˆã€‚æœªæŒ‡å®šãªã‚‰ localStorage('ffbase')ã€‚æœ«å°¾ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ä»˜ä¸ã€‚
    function getFFBaseOverride() {
      const u = new URL(location.href);
      const p = u.searchParams.get('ffbase');
      if (p) {
        const v = p.endsWith('/') ? p : p + '/';
        localStorage.setItem('ffbase', v);
        return v;
      }
      const s = localStorage.getItem('ffbase');
      return s ? (s.endsWith('/') ? s : s + '/') : null;
    }

    // ã“ã®HTMLã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆæœ«å°¾/ã‚ã‚Šï¼‰
    const hereDir = location.pathname.replace(/[^/]+$/, '');

    // è‡ªå‹•æ¢ç´¢å€™è£œã‚’ä½œæˆï¼ˆoverride â†’ ä»£è¡¨çš„ãªç›¸å¯¾/çµ¶å¯¾ï¼‰
    function buildCandidates() {
      const cand = [];
      const ov = getFFBaseOverride();
      if (ov) cand.push(ov);
      cand.push(
        '/lib/ffmpeg/',
        hereDir + 'lib/ffmpeg/',
        hereDir + 'ffmpeg/',
        hereDir.replace(/[^/]+\/$/, '') + 'lib/ffmpeg/'
      );
      return [...new Set(cand)].map(b => (b.endsWith('/') ? b : b + '/'));
    }

    function loadScript(src, timeoutMs = 6000) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        let done = false;
        const tid = setTimeout(() => { if (done) return; done = true; s.remove(); reject(new Error('Timeout: ' + src)); }, timeoutMs);
        s.onload = () => { if (done) return; done = true; clearTimeout(tid); resolve(); };
        s.onerror = () => { if (done) return; done = true; clearTimeout(tid); reject(new Error('Failed: ' + src)); };
        document.head.appendChild(s);
      });
    }

    async function tryLoadLocalUMD(bases) {
      const tried = [];
      for (const base of bases) {
        const url = base + 'ffmpeg.min.js';
        console.log('[UMD/local] try:', url);
        tried.push(url);
        try {
          await loadScript(url, 7000);
          if (!(window.FFmpeg && FFmpeg.createFFmpeg && FFmpeg.fetchFile)) {
            throw new Error('FFmpeg global missing after load');
          }
          console.log('[UMD/local] loaded:', url);
          return base; // æˆåŠŸ
        } catch (e) {
          console.warn('[UMD/local] failed:', e.message);
        }
      }
      const logEl = document.getElementById('log');
      if (logEl) {
        logEl.textContent += '\nâŒ ffmpeg.min.js æ¢ç´¢å¤±æ•—ã€‚è©¦è¡ŒURL:\n- ' + tried.join('\n- ');
        logEl.scrollTop = logEl.scrollHeight;
      }
      throw new Error('åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã® ffmpeg.min.js ã‚’èª­ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆé…ç½®ãƒ‘ã‚¹/ãƒ•ã‚¡ã‚¤ãƒ«å/MIMEã‚’ç¢ºèªï¼‰');
    }

    // å¤±æ•—æ™‚ã¯æ‰‹å…¥åŠ›ã§ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’å—ã‘ä»˜ã‘ã‚‹
    async function loadFFmpegLocalWithPrompt() {
      try {
        return await tryLoadLocalUMD(buildCandidates());
      } catch (e) {
        const hint = 'ffmpeg.min.js ã®ã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€URLã‚’å…¥åŠ›ï¼ˆä¾‹: /lib/ffmpeg/ ã‚„ ./ffmpeg/ ãªã©ï¼‰ã€‚\n' +
                     'æ¬¡å›ä»¥é™ã¯ localStorage ã® ffbase ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚';
        const manual = prompt(hint, localStorage.getItem('ffbase') || '/lib/ffmpeg/');
        if (manual) {
          const base = manual.endsWith('/') ? manual : manual + '/';
          localStorage.setItem('ffbase', base);
          return await tryLoadLocalUMD([base]);
        }
        throw e;
      }
    }
  </script>

  <!-- â˜… ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
  <script>
    // =============================
    // å‚ç…§ï¼ˆDOMï¼‰
    // =============================
    const els = {
      file: document.getElementById('file'),
      analyze: document.getElementById('analyzeBtn'),
      recalc: document.getElementById('recalcBtn'),
      cut: document.getElementById('cutBtn'),
      wave: document.getElementById('wave'),
      segList: document.getElementById('segList'),
      thresh: document.getElementById('thresh'),
      threshVal: document.getElementById('threshVal'),
      minSil: document.getElementById('minSil'),
      minSilVal: document.getElementById('minSilVal'),
      pad: document.getElementById('pad'),
      padVal: document.getElementById('padVal'),
      win: document.getElementById('win'),
      winVal: document.getElementById('winVal'),
      live: document.getElementById('live'),
      analysisMeta: document.getElementById('analysisMeta'),
      log: document.getElementById('log'),
      prog: document.getElementById('prog'),
      outWrap: document.getElementById('outWrap'),
      player: document.getElementById('player'),
      previewToggle: document.getElementById('previewToggle'),
      previewStart: document.getElementById('previewStart'),
      previewStop: document.getElementById('previewStop'),
      outNameInput: document.getElementById('outNameInput'),
      crf: document.getElementById('crf'),
      crfVal: document.getElementById('crfVal'),
      preset: document.getElementById('preset'),
      abitrate: document.getElementById('abitrate'),
      makeProxyBtn: document.getElementById('makeProxyBtn'),
      proxyHint: document.getElementById('proxyHint'),
      diagBtn: document.getElementById('diagBtn'),
    };

    function log(msg){ els.log.textContent += `\n${msg}`; els.log.scrollTop=els.log.scrollHeight; }
    function error(msg){ log(`âŒ ${msg}`); }

    // =============================
    // çŠ¶æ…‹
    // =============================
    let decoded = null; // {audioBuffer, duration}
    let analysis = null; // {dbfs: Float32Array, stepSec, duration}
    let keepSegments = []; // [{start,end}]
    let inputBlobURL = null;
    let previewOn = false;
    let previewHandlersBound = false;

    // =============================
    // ffmpegï¼ˆãƒ­ãƒ¼ã‚«ãƒ«è‡ªå‹•æ¤œå‡º + ffbase æŒ‡å®šå¯¾å¿œï¼‰
    // =============================
    let ffmpeg = null, ffmpegReady = false, FF_BASE = null;

    async function ensureFFmpeg(){
      if(ffmpegReady) return;
      try{
        FF_BASE = await loadFFmpegLocalWithPrompt(); // è‡ªå‹•â†’å¤±æ•—â†’æ‰‹å…¥åŠ›/ffbaseæŒ‡å®š
      }catch(e){
        error(e.message + '\nãƒ’ãƒ³ãƒˆ: URLæœ«å°¾ã« ?ffbase=/ã‚ãªãŸã®ãƒ‘ã‚¹/ ã‚’ä»˜ã‘ã¦å†èª­ã¿è¾¼ã¿ã§ã‚‚æŒ‡å®šå¯èƒ½');
        throw e;
      }
      if(!(window.FFmpeg && FFmpeg.createFFmpeg && FFmpeg.fetchFile)){
        throw new Error('ffmpeg.min.js ã¯èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸãŒ FFmpeg ã‚°ãƒ­ãƒ¼ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³/ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªï¼‰');
      }
      const { createFFmpeg } = FFmpeg;
      ffmpeg = createFFmpeg({
        corePath: FF_BASE + 'ffmpeg-core.js',
        log: true,
        logger: ({ type, message }) => { els.log.textContent += `\n[ffmpeg:${type}] ${message}`; els.log.scrollTop = els.log.scrollHeight; },
        progress: ({ ratio }) => { const r = Number.isFinite(ratio)?Math.min(1,Math.max(0,ratio)):0; els.prog.style.width = `${r*100}%`; }
      });
      log(`ffmpeg.wasm èµ·å‹•ä¸­ï¼ˆbase=${FF_BASE}ï¼‰â€¦`);
      await ffmpeg.load();
      ffmpegReady = true;
      log('ffmpeg.wasm æº–å‚™å®Œäº†');
    }

    // =============================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆUIãƒ©ãƒ™ãƒ«ï¼‰
    // =============================
    const syncLabels=()=>{
      els.threshVal.textContent = `${els.thresh.value} dB`;
      els.minSilVal.textContent = `${els.minSil.value} ms`;
      els.padVal.textContent = `${els.pad.value} ms`;
      els.winVal.textContent = `${els.win.value} ms`;
      els.crfVal.textContent = `CRF ${els.crf.value}`;
    };
    ['thresh','minSil','pad','win','crf'].forEach(id=>els[id].addEventListener('input',()=>{
      syncLabels();
      if(els.live.checked && decoded) debouncedRecompute();
      else drawWave(analysis?.dbfs||[]);
    }));
    syncLabels();

    function ensureCutState(){ els.cut.disabled = !(decoded && analysis); }
    let recomputeTimer=null; function debouncedRecompute(){ clearTimeout(recomputeTimer); recomputeTimer=setTimeout(()=>computeAnalysis(), 160); }

    // =============================
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
    // =============================
    els.file.addEventListener('change',()=>{
      const f = els.file.files?.[0];
      if(!f){ els.analyze.disabled = true; ensureCutState(); return; }
      els.analyze.disabled = false; els.recalc.disabled = true;
      decoded = null; analysis = null; keepSegments = [];
      drawWave([]); els.segList.textContent = 'è§£æå¾…ã¡â€¦';
      els.outWrap.innerHTML = '';
      ensureCutState();
      log(`é¸æŠ: ${f.name} (${(f.size/1e6).toFixed(1)} MB)`);
      if(inputBlobURL) URL.revokeObjectURL(inputBlobURL);
      inputBlobURL = URL.createObjectURL(f);
      els.player.src = inputBlobURL;
      els.player.load();
      els.previewStart.disabled = false; els.previewStop.disabled = false;
      els.previewToggle.disabled = true;
      els.makeProxyBtn.style.display = 'none'; els.proxyHint.textContent = '';
    });

    // =============================
    // éŸ³é‡è§£æï¼ˆWeb Audio APIï¼‰
    // =============================
    els.analyze.addEventListener('click', async()=>{
      const file = els.file.files?.[0]; if(!file) return;
      els.analyze.disabled = true; log('éŸ³å£°ãƒ‡ã‚³ãƒ¼ãƒ‰ä¸­â€¦');
      try{
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        const buf = await ac.decodeAudioData(await file.arrayBuffer());
        const duration = buf.duration; decoded = {audioBuffer:buf, duration};
        log(`Audio decoded: ${duration.toFixed(3)} sec, ch=${buf.numberOfChannels}, sr=${buf.sampleRate}`);
        await computeAnalysis();
        els.recalc.disabled = false;
        els.previewToggle.disabled = false; els.previewStart.disabled = false; els.previewStop.disabled = false;
      }catch(err){
        error(`ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—: ${err?.message||err}`);
        els.analyze.disabled = false;
      }finally{
        ensureCutState();
      }
    });

    // =============================
    // å†è§£æ
    // =============================
    els.recalc.addEventListener('click', async()=>{ if(!decoded) return; await computeAnalysis(); });

    // =============================
    // è§£ææœ¬ä½“
    // =============================
    async function computeAnalysis(){
      if(!decoded){ ensureCutState(); return; }
      try{
        const {audioBuffer, duration} = decoded; const sr = audioBuffer.sampleRate; const ch = audioBuffer.numberOfChannels;
        const winMs = +els.win.value; const stepSamples = Math.max(1, Math.round((winMs/1000)*sr));
        const len = Math.ceil(audioBuffer.length / stepSamples); const dbfs = new Float32Array(len);
        const eps = 1e-12; const chData = Array.from({length:ch}, (_,i)=>audioBuffer.getChannelData(i));
        let idx=0; for(let s=0; s<audioBuffer.length; s+=stepSamples){
          const end = Math.min(s+stepSamples, audioBuffer.length); let sumsq=0, count=0;
          for(let i=s;i<end;i++){ let sample=0; for(let c=0;c<ch;c++) sample += chData[c][i]||0; sample/=ch; sumsq += sample*sample; count++; }
          const rms = Math.sqrt(sumsq/Math.max(1,count)); dbfs[idx++] = 20*Math.log10(Math.max(rms, eps));
        }
        analysis = {dbfs, stepSec: stepSamples/sr, duration};

        const thr = +els.thresh.value; const minSil = +els.minSil.value/1000; const pad = +els.pad.value/1000;
        keepSegments = buildKeepSegments(dbfs, analysis.stepSec, duration, thr, minSil, pad);
        els.analysisMeta.textContent = `æ¤œå‡ºã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: ${winMs}ms, ã‚µãƒ³ãƒ—ãƒ«æ•°: ${dbfs.length}, æ®‹ã™åŒºé–“: ${keepSegments.length} å€‹`;
        drawWave(dbfs); renderSegments();

        ensureCutState();
        if (keepSegments.length > 0) els.cut.disabled = false;

        if(previewOn){
          const seg = withinKeep(els.player.currentTime);
          if(!seg && keepSegments[0]) els.player.currentTime = keepSegments[0].start;
        }
      }catch(e){
        error(`è§£æã‚¨ãƒ©ãƒ¼: ${e?.message||e}`);
      }finally{
        ensureCutState();
      }
    }

    function buildKeepSegments(dbfs, step, duration, thr, minSil, pad){
      const mask = dbfs.map(v=> v >= thr ? 1 : 0); const segs=[]; let runStart=null;
      for(let i=0;i<mask.length;i++){
        if(mask[i]===1 && runStart===null){ runStart=i; }
        if((mask[i]===0 || i===mask.length-1) && runStart!==null){
          const last = (mask[i]===0 ? i-1 : i);
          const st = runStart*step; const en = Math.min((last+1)*step, duration);
          segs.push({start:st, end:en}); runStart=null;
        }
      }
      const merged=[];
      for(const s of segs){
        const prev = merged[merged.length-1];
        if(prev && s.start - prev.end < minSil){ prev.end = s.end; }
        else { merged.push({...s}); }
      }
      return merged.map(s=>({ start:Math.max(0,s.start-pad), end:Math.min(duration,s.end+pad) }));
    }

    // =============================
    // æ³¢å½¢æç”»
    // =============================
    function drawWave(dbfs){
      const canvas = els.wave; const dpr = window.devicePixelRatio||1; const W = canvas.clientWidth; const H = canvas.clientHeight;
      canvas.width = Math.floor(W*dpr); canvas.height = Math.floor(H*dpr); const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,W,H);
      ctx.strokeStyle = '#1f2a35'; ctx.lineWidth=1; ctx.beginPath(); for(let y=0;y<=4;y++){ const yy=(H-20)*(y/4)+10; ctx.moveTo(8,yy); ctx.lineTo(W-8,yy);} ctx.stroke();
      const toY=v=>{ const clamped=Math.max(-90,Math.min(0,v||-90)); const t=(clamped+90)/90; return 10+(1-t)*(H-20); };
      const tToX=t=> 10 + ((t/(analysis?.duration||1))*(W-20));
      if(analysis && keepSegments.length){ ctx.fillStyle='rgba(108,225,166,0.18)'; keepSegments.forEach(s=>{ const x1=tToX(s.start), x2=tToX(s.end); ctx.fillRect(x1,10,Math.max(1,x2-x1),H-20); }); }
      if(dbfs && dbfs.length){ ctx.strokeStyle='#6ce1a6'; ctx.lineWidth=1; ctx.beginPath(); for(let i=0;i<dbfs.length;i++){ const x=10 + (i/(dbfs.length-1))*(W-20); const y=toY(dbfs[i]); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.stroke(); }
      const thr=+els.thresh.value; const ythr=toY(thr); ctx.strokeStyle='#4aa3ff'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(8,ythr); ctx.lineTo(W-8,ythr); ctx.stroke(); ctx.setLineDash([]);
    }

    function renderSegments(){
      if(!keepSegments.length){
        els.segList.innerHTML = '<div>æ¤œå‡ºã•ã‚ŒãŸä¿æŒåŒºé–“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã—ãã„å€¤ã‚’ä¸‹ã’ã¦ãã ã•ã„ã€‚</div>';
        return;
      }
      const fmt=t=> new Date(t*1000).toISOString().substring(11,23);
      els.segList.innerHTML = keepSegments.map((s,i)=>`<div>#${i+1} <span class="mono">${fmt(s.start)}</span> â†’ <span class="mono">${fmt(s.end)}</span> <span class="hint">(${(s.end-s.start).toFixed(2)}s)</span></div>`).join('');
    }

    // =============================
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç„¡éŸ³ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    // =============================
    function withinKeep(t){ for(const seg of keepSegments){ if(t>=seg.start && t<seg.end) return seg; } return null; }
    function nextKeepStartAfter(t){ for(const seg of keepSegments){ if(seg.end <= t) continue; if(t < seg.start) return seg.start; } return null; }
    function bindPreviewHandlers(){
      if(previewHandlersBound) return;
      els.player.addEventListener('timeupdate',()=>{
        if(!previewOn || !keepSegments.length) return;
        const t=els.player.currentTime; const seg=withinKeep(t);
        if(!seg){
          const nextStart = nextKeepStartAfter(t);
          if(nextStart!=null){ els.player.currentTime = nextStart; }
          else { els.player.pause(); }
        }
      });
      previewHandlersBound=true;
    }
    bindPreviewHandlers();
    els.player.addEventListener('loadedmetadata', ()=>{ log(`ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—: duration=${(els.player.duration||0).toFixed(2)}s`); });
    els.player.addEventListener('error', ()=>{
      error('å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ã«æœªå¯¾å¿œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
      detectAndOfferProxy();
    });
    els.previewToggle.addEventListener('change',()=>{ previewOn = !!els.previewToggle.checked; if(previewOn && keepSegments.length){ els.player.currentTime = keepSegments[0].start; } });
    els.previewStart.addEventListener('click',()=>{ if(keepSegments.length && previewOn){ els.player.currentTime = keepSegments[0].start; } els.player.play(); });
    els.previewStop.addEventListener('click',()=>{ els.player.pause(); });

    els.wave.addEventListener('click',(e)=>{
      if(!analysis) return;
      const rect=els.wave.getBoundingClientRect(); const x=(e.clientX-rect.left)/rect.width; const t=x*analysis.duration;
      if(previewOn){
        const seg=withinKeep(t);
        if(!seg){
          const nxt=nextKeepStartAfter(t);
          if(nxt!=null) els.player.currentTime=nxt; else els.player.pause();
          return;
        }
      }
      els.player.currentTime=t;
    });

    function detectAndOfferProxy(){
      try{
        const v = document.createElement('video');
        const hev1 = v.canPlayType('video/mp4; codecs="hev1"');
        const hvc1 = v.canPlayType('video/mp4; codecs="hvc1"');
        if(hev1==='' && hvc1===''){
          els.makeProxyBtn.style.display = 'inline-block';
          els.proxyHint.textContent = 'HEVC(hevc/hvc1)ãŒå†ç”Ÿã§ããªã„å ´åˆã¯äº’æ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚';
        }
      }catch(_e){ els.makeProxyBtn.style.display = 'inline-block'; }
    }

    // =============================
    // æ›¸ãå‡ºã—ï¼ˆffmpeg.wasmï¼‰
    // =============================
    els.cut.addEventListener('click', async()=>{
      log('æ›¸ãå‡ºã—é–‹å§‹â€¦');

      if (!Array.isArray(keepSegments) || keepSegments.length === 0) {
        error('ä¿æŒåŒºé–“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã—ãã„å€¤â†“ / æœ€å°ç„¡éŸ³é•·â†“ ã§å†è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚');
        els.segList.scrollIntoView({behavior:'smooth'});
        ensureCutState();
        return;
      }
      const file = els.file.files?.[0];
      if (!file) {
        error('å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‹•ç”»ã‚’é¸æŠâ†’è§£æã—ã¦ãã ã•ã„ã€‚');
        ensureCutState();
        return;
      }

      els.cut.disabled = true; els.recalc.disabled = true; els.analyze.disabled = true; els.prog.style.width='0%';
      try{
        try { await ensureFFmpeg(); }
        catch(e){ error('ffmpegåˆæœŸåŒ–ã«å¤±æ•—ï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ã®é…ç½®/ãƒ•ã‚¡ã‚¤ãƒ«å/MIMEã‚’ç¢ºèªï¼‰'); throw e; }

        const inName = 'input.mp4';
        const { fetchFile } = FFmpeg;
        ffmpeg.FS('writeFile', inName, await fetchFile(file));

        const chains=[]; const maps=[];
        keepSegments.forEach((s,i)=>{
          const st=s.start.toFixed(3), en=s.end.toFixed(3);
          chains.push(`[0:v]trim=start=${st}:end=${en},setpts=PTS-STARTPTS[v${i}]`);
          chains.push(`[0:a]atrim=start=${st}:end=${en},asetpts=PTS-STARTPTS[a${i}]`);
          maps.push(`[v${i}][a${i}]`);
        });
        const filter = `${chains.join(';')};${maps.join('')}concat=n=${keepSegments.length}:v=1:a=1[v][a]`;
        log(`filter_complex\n${filter}`);

        const outName = 'out.mp4';
        let saveName = (els.outNameInput.value||'cut_output.mp4').trim();
        if(!/\.(mp4|mov|m4v)$/i.test(saveName)) saveName += '.mp4';

        try{
          await ffmpeg.run(
            '-y','-i', inName,
            '-filter_complex', filter,
            '-map','[v]','-map','[a]',
            '-c:v','libx264','-preset', els.preset.value,'-crf', String(els.crf.value),
            '-c:a','aac','-b:a', els.abitrate.value,
            '-movflags','+faststart',
            outName
          );
        }catch(first){
          log('ä¸€æ¬¡æ›¸ãå‡ºã—å¤±æ•— â†’ éŸ³å£°ãªã—ã§å†è©¦è¡Œâ€¦');
          try{
            const filterV = keepSegments
              .map((s,i)=>`[0:v]trim=start=${s.start.toFixed(3)}:end=${s.end.toFixed(3)},setpts=PTS-STARTPTS[v${i}]`).join(';')
              + `;${keepSegments.map((_,i)=>`[v${i}]`).join('')}concat=n=${keepSegments.length}:v=1:a=0[v]`;
            await ffmpeg.run(
              '-y','-i', inName,
              '-filter_complex', filterV,
              '-map','[v]',
              '-c:v','libx264','-preset', els.preset.value,'-crf', String(els.crf.value),
              '-movflags','+faststart',
              outName
            );
          }catch(second){
            log('éŸ³å£°ãªã—å¤±æ•— â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã§æœ€çµ‚è©¦è¡Œâ€¦');
            await ffmpeg.run('-y','-i', inName,'-filter_complex', filter,'-map','[v]','-map','[a]', outName);
          }
        }

        const data = ffmpeg.FS('readFile', outName);
        const blob = new Blob([data.buffer], {type:'video/mp4'});

        async function saveWithPicker(){
          if('showSaveFilePicker' in window){
            try{
              const handle = await window.showSaveFilePicker({
                suggestedName: saveName,
                types: [{ description: 'MP4 Video', accept: {'video/mp4': ['.mp4']} }]
              });
              const writable = await handle.createWritable();
              await writable.write(blob);
              await writable.close();
              log('ä¿å­˜å®Œäº†ï¼ˆFile System Access APIï¼‰');
              return true;
            }catch(e){
              error('ä¿å­˜ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«/å¤±æ•—: '+(e?.message||e));
              return false;
            }
          }
          return false;
        }
        const saved = await saveWithPicker();

        const url = URL.createObjectURL(blob);
        const sizeMB = (blob.size/1e6).toFixed(1);
        els.outWrap.innerHTML = `<div class="ok">âœ… æ›¸ãå‡ºã—å®Œäº†: ${sizeMB} MB</div>
          <video controls style="width:100%;max-height:360px;margin-top:8px;border:1px solid #1e2a34;border-radius:10px" src="${url}"></video>
          <div style="margin-top:8px">` +
          (saved ? `<button class="secondary" id="resetBtn">åˆ¥ã®å‹•ç”»ã§ã‚„ã‚Šç›´ã™</button>` :
            `<a download="${saveName}" href="${url}"><button>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button></a> <button class="secondary" id="resetBtn">åˆ¥ã®å‹•ç”»ã§ã‚„ã‚Šç›´ã™</button>`) +
          `</div>`;
        document.getElementById('resetBtn')?.addEventListener('click',()=>location.reload());
        log('å®Œäº†');
      }catch(e){
        error(e?.message||e);
      }finally{
        ensureCutState();
        els.recalc.disabled = false;
        els.analyze.disabled = false;
      }
    });

    // =============================
    // è¨ºæ–­
    // =============================
    els.diagBtn.addEventListener('click', async()=>{
      log('[è¨ºæ–­] é–‹å§‹');
      try{
        const canPlayMP4 = !!document.createElement('video').canPlayType('video/mp4');
        log(`[è¨ºæ–­] MP4 å†ç”Ÿå¯: ${canPlayMP4}`);
        // UMD è‡ªå‹•/æ‰‹å‹•ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®æ¤œè¨¼
        try{
          const base = await loadFFmpegLocalWithPrompt();
          log(`[è¨ºæ–­] ffmpeg.min.js ãƒ­ãƒ¼ãƒ‰OKï¼ˆbase=${base}ï¼‰`);
        }catch(e){
          error('[è¨ºæ–­] ffmpeg.min.js ãƒ­ãƒ¼ãƒ‰å¤±æ•—: '+e.message);
          throw e;
        }
        await ensureFFmpeg();
        log('[è¨ºæ–­] ffmpeg.wasm åˆ©ç”¨å¯èƒ½');
        log('[è¨ºæ–­] æˆåŠŸ');
      }catch(e){ error('[è¨ºæ–­] å¤±æ•—: '+(e?.message||e)); }
      finally{ ensureCutState(); }
    });
  </script>
</body>
</html>
