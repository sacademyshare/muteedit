name: Populate ffmpeg runtime (GitHub Pages)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch tarballs via npm pack and extract exact files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p assets/ffmpeg

          echo "==> npm pack @ffmpeg/ffmpeg@0.12.7"
          FF_TGZ=$(npm pack @ffmpeg/ffmpeg@0.12.7 --silent)
          echo "created: $FF_TGZ"
          tar -tzf "$FF_TGZ" | sed -n '1,120p'

          # --- UMD main ---
          UMD_PATH=$(tar -tzf "$FF_TGZ" | grep -E '(^|/)dist/umd/ffmpeg\.js$' | head -n1)
          test -n "$UMD_PATH" || { echo "dist/umd/ffmpeg.js not found in $FF_TGZ"; exit 1; }
          tar -xOf "$FF_TGZ" "$UMD_PATH" > assets/ffmpeg/ffmpeg.min.js

          # --- UMD が依存する 814 チャンク（0.12 系で使用される）---
          WORKER814=$(tar -tzf "$FF_TGZ" | grep -E '(^|/)dist/umd/814\.ffmpeg\.js$' | head -n1 || true)
          if [ -n "$WORKER814" ]; then
            tar -xOf "$FF_TGZ" "$WORKER814" > assets/ffmpeg/814.ffmpeg.js
          fi

          rm -f "$FF_TGZ"

          echo "==> npm pack @ffmpeg/core@0.12.10"
          CORE_TGZ=$(npm pack @ffmpeg/core@0.12.10 --silent)
          echo "created: $CORE_TGZ"
          tar -tzf "$CORE_TGZ" | sed -n '1,200p'

          COREJS_PATH=$(tar -tzf "$CORE_TGZ" | grep -E '(^|/)ffmpeg-core\.js$'   | head -n1)
          WASM_PATH=$(   tar -tzf "$CORE_TGZ" | grep -E '(^|/)ffmpeg-core\.wasm$' | head -n1)

          echo "ffmpeg-core.js   -> $COREJS_PATH"
          echo "ffmpeg-core.wasm -> $WASM_PATH"

          test -n "$COREJS_PATH" || { echo "ffmpeg-core.js not found"; exit 1; }
          test -n "$WASM_PATH"   || { echo "ffmpeg-core.wasm not found"; exit 1; }

          tar -xOf "$CORE_TGZ" "$COREJS_PATH" > assets/ffmpeg/ffmpeg-core.js
          tar -xOf "$CORE_TGZ" "$WASM_PATH"   > assets/ffmpeg/ffmpeg-core.wasm

          # worker は .js / .mjs / そもそも無し など揺れるため“あれば取得”
          set +o pipefail
          CORE_WORKER_PATH=$(tar -tzf "$CORE_TGZ" | grep -E '(^|/)ffmpeg-core\.worker\.(m)?js$' | head -n1 || true)
          set -o pipefail
          if [ -n "${CORE_WORKER_PATH:-}" ]; then
            CORE_WORKER_BASENAME=$(basename "$CORE_WORKER_PATH")
            echo "ffmpeg-core.worker => $CORE_WORKER_PATH (-> $CORE_WORKER_BASENAME)"
            tar -xOf "$CORE_TGZ" "$CORE_WORKER_PATH" > "assets/ffmpeg/$CORE_WORKER_BASENAME"
          else
            echo "NOTE: ffmpeg-core.worker.* not found (core may not require a separate worker)."
          fi

          rm -f "$CORE_TGZ"

          echo "==> result"
          ls -lh assets/ffmpeg

          # 最低限サイズチェック
          test -s assets/ffmpeg/ffmpeg.min.js
          test -s assets/ffmpeg/ffmpeg-core.js
          test -s assets/ffmpeg/ffmpeg-core.wasm || { echo "ffmpeg-core.wasm is empty"; exit 1; }

      - name: Commit files
        run: |
          git config user.name  "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add -A
          git commit -m "Add / update ffmpeg runtime files for GitHub Pages" || echo "No changes"
          git push
