name: Populate ffmpeg runtime (npm pack, robust grep)
on: { workflow_dispatch: {} }
permissions: { contents: write }

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch tarballs via npm pack and extract exact files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p assets/ffmpeg

          echo "==> npm pack @ffmpeg/ffmpeg@0.12.7"
          FF_TGZ=$(npm pack @ffmpeg/ffmpeg@0.12.7 --silent)
          echo "created: $FF_TGZ"
          tar -tzf "$FF_TGZ" | sed -n '1,120p'
          # ffmpeg 側は umd/ffmpeg.js を採用（ファイル名は ffmpeg.min.js にリネームして配置）
          UMD_PATH=$(tar -tzf "$FF_TGZ" | grep -E '(^|/)dist/umd/ffmpeg\.js$' | head -n1)
          test -n "$UMD_PATH"
          tar -xOf "$FF_TGZ" "$UMD_PATH" > assets/ffmpeg/ffmpeg.min.js
          rm -f "$FF_TGZ"

          echo "==> npm pack @ffmpeg/core@0.12.10"
          CORE_TGZ=$(npm pack @ffmpeg/core@0.12.10 --silent)
          echo "created: $CORE_TGZ"
          # 一覧を表示（デバッグ用）
          tar -tzf "$CORE_TGZ" | sed -n '1,200p'

          # ---- ここがポイント：末尾ファイル名で検索（フォルダ名は問わない）----
          for fname in ffmpeg-core.js ffmpeg-core.wasm ffmpeg-core.worker.js; do
            # pipefail のままだと grep 未ヒットで止まるので一時的に -o pipefail を外す
            set +o pipefail
            P=$(tar -tzf "$CORE_TGZ" | grep -E "(^|/)$fname\$" | head -n1)
            set -o pipefail
            echo "$fname => $P"
            test -n "$P"
            tar -xOf "$CORE_TGZ" "$P" > "assets/ffmpeg/$fname"
          done
          rm -f "$CORE_TGZ"

          echo "==> result"
          ls -lh assets/ffmpeg
          # 0バイト防止のサイズチェック
          test -s assets/ffmpeg/ffmpeg.min.js
          test -s assets/ffmpeg/ffmpeg-core.js
          test -s assets/ffmpeg/ffmpeg-core.worker.js
          test -s assets/ffmpeg/ffmpeg-core.wasm

      - name: Commit files
        run: |
          git config user.name  "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add -A
          git commit -m "Add ffmpeg runtime files (robust grep)" || echo "No changes"
          git push
